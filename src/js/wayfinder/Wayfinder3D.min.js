function ClassCallback(t,e){return function(){return e.apply(t,arguments)}}var Class=function(){};!function(){var t=!1,e=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(i){function n(){!t&&this.init&&this.init.apply(this,arguments)}var o=this.prototype;t=!0;var a=new this;t=!1;for(var s in i)a[s]="function"==typeof i[s]&&"function"==typeof o[s]&&e.test(i[s])?function(t,e){return function(){var i=this._super;this._super=o[t];var n=e.apply(this,arguments);return this._super=i,n}}(s,i[s]):i[s];return n.prototype=a,n.prototype.constructor=n,n.extend=arguments.callee,n}}();var Callback=ClassCallback;if(void 0===Float32Array)var Float32Array=function(){return[0,0]};"undefined"!=typeof window&&(window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,16)}}(),function(){window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"function"!=typeof String.prototype.format&&(String.prototype.format=function(){var t=arguments;return this.replace(/{(\d+)}/g,function(e,i){return"undefined"!=typeof t[i]?t[i]:e})}),window.log=function(){log.history=log.history||[],log.history.push(arguments),this.console&&console.log(Array.prototype.slice.call(arguments))});var Logistics=function(){var t=!1;"undefined"!=typeof window&&(t="localStorage"in window&&null!==window.localStorage);var e=[],i=[],n={},o=0,a=!1,s=null,r=null,h=null,l=null,d={loadFromLocalStorage:!1,storeToLocalStorage:!1,loadFromFile:!1,enableCORS:!0,useCookies:!1,fallbackFromStorage:!0},c={text:{load:function(t){A(t)},parse:function(t,e){t.data=e.responseText},store:function(t){return t.data},restore:function(t,e){return e}},json:{load:function(t){A(t)},parse:function(t,e){try{t.data=JSON.parse(e.responseText)}catch(i){"undefined"!=typeof console&&console.error&&console.error("JSON parsing failed for "+t.url,i)}},store:function(t){return JSON.stringify(t.data)},restore:function(t,e){return e?JSON.parse(e):{}}},xml:{load:function(t){A(t)},parse:function(t,e){t.data=e.responseXML?e.responseXML:W(e.responseText)},store:function(t){return XMLSerializer?(new XMLSerializer).serializeToString(t.data):""},restore:function(t,e){return W(e)}},image:{load:function(t){t&&(t.data=new Image,t.useCORS&&(t.data.crossOrigin="Anonymous"),t.data.onload=function(){t.ready()},t.data.onerror=function(){t.failed()},t.data.src=t.url)},parse:function(){},store:function(t){var e=document.createElement("canvas");e.width=t.data.width,e.height=t.data.height;var i=e.getContext("2d");i.drawImage(t.data,0,0);var n=e.toDataURL("image/png");return e=null,n},restore:function(t,e){var i=new Image;return i.src=e,i}},binary:{load:function(t){A(t)},parse:function(t,e){t.data=e.response},store:function(t){for(var e="",i=new Uint8Array(t.data),n=i.byteLength,o=0;n>o;o++)e+=String.fromCharCode(i[o]);return window.btoa(e)},restore:function(t,e){for(var i=new ArrayBuffer(2*e.length),n=new Uint16Array(i),o=0,a=e.length;a>o;o++)n[o]=e.charCodeAt(o);return i}}},u=function(t,e,i,n,a,s){this.url=t,this.params=e,this.success=i,this.dataType=n,this.loaded=!1,this.data=!1,this.requestType=a,this.useCORS=!1,this.options=s?s:{},this.successCallback=i,this.errorCallback=!1,this.alwaysCallback=!1,this.progressCallback=!1,this.setOption=function(t,e){this.options[t]=e},this.getOption=function(t){return this.options[t]},this.ready=function(){this.loaded=!0,o++,D(this),T(this)},this.failed=function(){o++,T(this),R(this)},this.done=function(t){this.successCallback=t},this.fail=function(t){this.errorCallback=t},this.error=function(t){this.errorCallback=t},this.always=function(t){this.alwaysCallback=t},this.progress=function(t){this.progressCallback=t},this.toString=function(){return this.data}},f=function(t,e,i){this.urls=t,this.results={},this.loadedCount=0,this.count=0,this.successCallback=e,i=i?i:{},this.load=function(){var t=null,e=null;for(var n in this.urls)this.urls.hasOwnProperty(n)&&this.count++;for(var o in this.urls)if(e=this.urls[o],e&&e.url&&e.type)try{t=g(e.url,void 0,_(this,this.ready,o),e.type,JSON.parse(JSON.stringify(i))),t.setOption("logistics.multi.key",o),t.fail(_(this,this.fail))}catch(a){this.fail()}},this.ready=function(t,e,i){var n=i.getOption("logistics.multi.key");this.results[n]=t,this.loadedCount++,this.checkIfAllReady()},this.fail=function(){this.loadedCount++,this.checkIfAllReady()},this.getKeyForURL=function(){},this.checkIfAllReady=function(){this.loadedCount>=this.count&&"function"==typeof this.successCallback&&this.successCallback(this.results)}},g=function(t,i,n,o,a){var s="GET";"function"==typeof i?(n=i,i=void 0):i&&"object"==typeof i&&(s="POST");var r=new u(t,i,n,o,s,a);return d.enableCORS&&(r.useCORS=m(t)),r&&(e.push(r),v(r)),r},p=function(t,e,n){var o=new f(t,e,n);i.push(o),o.load()},m=function(t){if("undefined"==typeof document)return!1;var e=t.match(/(https?:)?\/\/([^\/]+)\/(.*)/);return e?document&&e[1]===document.location.origin?!1:!0:!1},y=function(t){if(t){var e=t.getOption("stage");e&&("object"!=typeof n[e]&&(n[e]=[]),n[e].push(t))}},v=function(t){return P(t),!0},P=function(t){y(t),d.loadFromLocalStorage&&I(t)?w(t):C(t.dataType,"load")(t)},I=function(e){return t&&null!==localStorage.getItem(e.url)?!0:!1},w=function(t){t.data=C(t.dataType,"restore")(t,N(t)),t.ready()},C=function(t,e){return c&&c[t]&&c[t][e]?c[t][e]:c&&c[t]?c[t]:function(){"undefined"!=typeof console&&console.warn&&console.warn("Method "+e+" for "+t+" not found")}},b=function(t,e){t&&e&&(c[t]=e)},A=function(t){var e=O(t);if(!e||!t)throw"http failed";var i=t.url;e.open(t.requestType,i,!0),e.overrideMimeType&&e.overrideMimeType("text/xml"),"binary"==t.dataType&&(e.responseType="arraybuffer",t.useCORS&&e.setRequestHeader("Content-Type","application/x-3dtechdata")),"default"==t.dataType&&(e.responseType="arraybuffer",t.useCORS&&e.setRequestHeader("Content-Type","application/octet-stream")),t.useCORS&&d.useCookies&&(e.withCredentials=!0),e.onreadystatechange=function(){4==e.readyState?200==e.status?(C(t.dataType,"parse")(t,e),t.ready()):t.failed():"function"==typeof t.progressCallback&&t.progressCallback(e)},e.ontimeout=function(){t.failed()},e.onerror=function(){t.failed()},T(t),e.send(null)},W=function(t){var e=null;if(!t||"string"!=typeof t)return e;if(window&&window.DOMParser){var i=new DOMParser;e=i.parseFromString(t,"text/xml")}else e=new ActiveXObject("Microsoft.XMLDOM"),e.async=!1,e.loadXML(t);if(!e||e.getElementsByTagName("parsererror").length)throw"XML parsing failed";return e},O=function(t){var e=!1;if(t.useCORS&&window&&window.XDomainRequest)try{e=new XDomainRequest}catch(i){e=!1}else if(XMLHttpRequest)try{e=new XMLHttpRequest}catch(n){e=!1}else if("undefined"!=typeof ActiveXObject)try{e=new ActiveXObject("Msxml2.XMLHTTP"),alert(2)}catch(n){try{e=new ActiveXObject("Microsoft.XMLHTTP"),alert(3)}catch(i){e=!1}}return e},S=function(){e=[],i=[],o=0,a=!1},M=function(){if(t)for(var i in e)x(e[i]);else console.warn("localStorage isn't supported")},L=function(){localStorage.clear()},x=function(e){if(t)try{localStorage[e.url]=C(e.dataType,"store")(e)}catch(i){console.warn("localStorage limit exceeded")}else console.warn("localStorage isn't supported")},N=function(t){return localStorage[t.url]},D=function(t){t&&"function"==typeof t.successCallback&&(t.successCallback(t.data,"success",t),k()),t&&d.storeToLocalStorage&&x(t)},R=function(t){if(t&&d.fallbackFromStorage&&I(t))return void w(t);if(!t||"function"!=typeof t.errorCallback)throw"Resource "+t.url+" not loaded";t.errorCallback(t,"error",""),k()},T=function(t){r&&"function"==typeof r&&e.length&&o&&r(o/e.length),t&&t.getOption("stage")&&F(t)},F=function(t){if(h&&"function"==typeof h){for(var e=n[t.getOption("stage")],i=e.length,o=0,a=0;i>a;a++)e[a]&&e[a].loaded&&o++;i>0&&h(t.getOption("stage"),o/i)}},k=function(){null===l&&(l=setTimeout(U,5))},U=function(){l=null,e.length==o&&s&&"function"==typeof s&&s()},_=function(t,e){return function(){return e.apply(t,arguments)}},E=function(t,e){d[t]=e},B=function(t){return d[t]};return{count:function(){return e.length},loadedCount:function(){return o},clear:function(){S()},get:function(t,e,i,n,o){return g(t,e,i,toLowerCase(n),o)},getJSON:function(t,e,i,n){return g(t,e,i,"json",n)},getImage:function(t,e,i,n){return g(t,e,i,"image",n)},getBinary:function(t,e,i,n){return g(t,e,i,"binary",n)},getXML:function(t,e,i,n){return g(t,e,i,"xml",n)},getText:function(t,e,i,n){return g(t,e,i,"text",n)},getMultiple:function(t,e,i){p(t,e,i)},store:function(){M()},clearStorage:function(){L()},types:function(){return c},onFinishedLoading:function(t){s=t},onProgress:function(t){r=t},onStageProgress:function(t){h=t},getQueue:function(){return e},getTypeFunction:function(t,e){return C(t,e)},setTypeFunction:function(t,e){return b(t,e)},getOption:function(t){return B(t)},setOption:function(t,e){E(t,e)},start:function(){return start()}}}();!function(t,e){"use strict";function i(){n.READY||(v.determineEventTypes(),y.each(n.gestures,function(t){I.register(t)}),v.onTouch(n.DOCUMENT,f,I.detect),v.onTouch(n.DOCUMENT,g,I.detect),n.READY=!0)}var n=function w(t,e){return new w.Instance(t,e||{})};n.VERSION="1.1.2",n.defaults={behavior:{userSelect:"none",touchAction:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}},n.DOCUMENT=document,n.HAS_POINTEREVENTS=navigator.pointerEnabled||navigator.msPointerEnabled,n.HAS_TOUCHEVENTS="ontouchstart"in t,n.IS_MOBILE=/mobile|tablet|ip(ad|hone|od)|android|silk/i.test(navigator.userAgent),n.NO_MOUSEEVENTS=n.HAS_TOUCHEVENTS&&n.IS_MOBILE||n.HAS_POINTEREVENTS,n.CALCULATE_INTERVAL=25;var o={},a=n.DIRECTION_DOWN="down",s=n.DIRECTION_LEFT="left",r=n.DIRECTION_UP="up",h=n.DIRECTION_RIGHT="right",l=n.POINTER_MOUSE="mouse",d=n.POINTER_TOUCH="touch",c=n.POINTER_PEN="pen",u=n.EVENT_START="start",f=n.EVENT_MOVE="move",g=n.EVENT_END="end",p=n.EVENT_RELEASE="release",m=n.EVENT_TOUCH="touch";n.READY=!1,n.plugins=n.plugins||{},n.gestures=n.gestures||{};var y=n.utils={extend:function(t,i,n){for(var o in i)!i.hasOwnProperty(o)||t[o]!==e&&n||(t[o]=i[o]);return t},on:function(t,e,i){t.addEventListener(e,i,!1)},off:function(t,e,i){t.removeEventListener(e,i,!1)},each:function(t,i,n){var o,a;if("forEach"in t)t.forEach(i,n);else if(t.length!==e){for(o=0,a=t.length;a>o;o++)if(i.call(n,t[o],o,t)===!1)return}else for(o in t)if(t.hasOwnProperty(o)&&i.call(n,t[o],o,t)===!1)return},inStr:function(t,e){return t.indexOf(e)>-1},inArray:function(t,e){if(t.indexOf){var i=t.indexOf(e);return-1===i?!1:i}for(var n=0,o=t.length;o>n;n++)if(t[n]===e)return n;return!1},toArray:function(t){return Array.prototype.slice.call(t,0)},hasParent:function(t,e){for(;t;){if(t==e)return!0;t=t.parentNode}return!1},getCenter:function(t){var e=[],i=[],n=[],o=[],a=Math.min,s=Math.max;return 1===t.length?{pageX:t[0].pageX,pageY:t[0].pageY,clientX:t[0].clientX,clientY:t[0].clientY}:(y.each(t,function(t){e.push(t.pageX),i.push(t.pageY),n.push(t.clientX),o.push(t.clientY)}),{pageX:(a.apply(Math,e)+s.apply(Math,e))/2,pageY:(a.apply(Math,i)+s.apply(Math,i))/2,clientX:(a.apply(Math,n)+s.apply(Math,n))/2,clientY:(a.apply(Math,o)+s.apply(Math,o))/2})},getVelocity:function(t,e,i){return{x:Math.abs(e/t)||0,y:Math.abs(i/t)||0}},getAngle:function(t,e){var i=e.clientX-t.clientX,n=e.clientY-t.clientY;return 180*Math.atan2(n,i)/Math.PI},getDirection:function(t,e){var i=Math.abs(t.clientX-e.clientX),n=Math.abs(t.clientY-e.clientY);return i>=n?t.clientX-e.clientX>0?s:h:t.clientY-e.clientY>0?r:a},getDistance:function(t,e){var i=e.clientX-t.clientX,n=e.clientY-t.clientY;return Math.sqrt(i*i+n*n)},getScale:function(t,e){return t.length>=2&&e.length>=2?this.getDistance(e[0],e[1])/this.getDistance(t[0],t[1]):1},getRotation:function(t,e){return t.length>=2&&e.length>=2?this.getAngle(e[1],e[0])-this.getAngle(t[1],t[0]):0},isVertical:function(t){return t==r||t==a},setPrefixedCss:function(t,e,i,n){var o=["","Webkit","Moz","O","ms"];e=y.toCamelCase(e);for(var a=0;a<o.length;a++){var s=e;if(o[a]&&(s=o[a]+s.slice(0,1).toUpperCase()+s.slice(1)),s in t.style){t.style[s]=(null==n||n)&&i||"";break}}},toggleBehavior:function(t,e,i){if(e&&t&&t.style){y.each(e,function(e,n){y.setPrefixedCss(t,n,e,i)});var n=i&&function(){return!1};"none"==e.userSelect&&(t.onselectstart=n),"none"==e.userDrag&&(t.ondragstart=n)}},toCamelCase:function(t){return t.replace(/[_-]([a-z])/g,function(t){return t[1].toUpperCase()})}},v=n.event={preventMouseEvents:!1,started:!1,shouldDetect:!1,on:function(t,e,i,n){var o=e.split(" ");y.each(o,function(e){y.on(t,e,i),n&&n(e)})},off:function(t,e,i,n){var o=e.split(" ");y.each(o,function(e){y.off(t,e,i),n&&n(e)})},onTouch:function(t,e,i){var a=this,s=function(o){var s,r=o.type.toLowerCase(),h=n.HAS_POINTEREVENTS,l=y.inStr(r,"mouse");l&&a.preventMouseEvents||(l&&e==u&&0===o.button?(a.preventMouseEvents=!1,a.shouldDetect=!0):h&&e==u?a.shouldDetect=1===o.buttons:l||e!=u||(a.preventMouseEvents=!0,a.shouldDetect=!0),h&&e!=g&&P.updatePointer(e,o),a.shouldDetect&&(s=a.doDetect.call(a,o,e,t,i)),s==g&&(a.preventMouseEvents=!1,a.shouldDetect=!1,P.reset()),h&&e==g&&P.updatePointer(e,o))};return this.on(t,o[e],s),s},doDetect:function(t,e,i,n){var o=this.getTouchList(t,e),a=o.length,s=e,r=o.trigger,h=a;e==u?r=m:e==g&&(r=p,h=o.length-(t.changedTouches?t.changedTouches.length:1)),h>0&&this.started&&(s=f),this.started=!0;var l=this.collectEventData(i,s,o,t);return e!=g&&n.call(I,l),r&&(l.changedLength=h,l.eventType=r,n.call(I,l),l.eventType=s,delete l.changedLength),s==g&&(n.call(I,l),this.started=!1),s},determineEventTypes:function(){var e;return e=n.HAS_POINTEREVENTS?t.PointerEvent?["pointerdown","pointermove","pointerup pointercancel lostpointercapture"]:["MSPointerDown","MSPointerMove","MSPointerUp MSPointerCancel MSLostPointerCapture"]:n.NO_MOUSEEVENTS?["touchstart","touchmove","touchend touchcancel"]:["touchstart mousedown","touchmove mousemove","touchend touchcancel mouseup"],o[u]=e[0],o[f]=e[1],o[g]=e[2],o},getTouchList:function(t,e){if(n.HAS_POINTEREVENTS)return P.getTouchList();if(t.touches){if(e==f)return t.touches;var i=[],o=[].concat(y.toArray(t.touches),y.toArray(t.changedTouches)),a=[];return y.each(o,function(t){y.inArray(i,t.identifier)===!1&&a.push(t),i.push(t.identifier)}),a}return t.identifier=1,[t]},collectEventData:function(t,e,i,n){var o=d;return y.inStr(n.type,"mouse")||P.matchType(l,n)?o=l:P.matchType(c,n)&&(o=c),{center:y.getCenter(i),timeStamp:Date.now(),target:n.target,touches:i,eventType:e,pointerType:o,srcEvent:n,preventDefault:function(){var t=this.srcEvent;t.preventManipulation&&t.preventManipulation(),t.preventDefault&&t.preventDefault()},stopPropagation:function(){this.srcEvent.stopPropagation()},stopDetect:function(){return I.stopDetect()}}}},P=n.PointerEvent={pointers:{},getTouchList:function(){var t=[];return y.each(this.pointers,function(e){t.push(e)}),t},updatePointer:function(t,e){t==g||t!=g&&1!==e.buttons?delete this.pointers[e.pointerId]:(e.identifier=e.pointerId,this.pointers[e.pointerId]=e)},matchType:function(t,e){if(!e.pointerType)return!1;var i=e.pointerType,n={};return n[l]=i===(e.MSPOINTER_TYPE_MOUSE||l),n[d]=i===(e.MSPOINTER_TYPE_TOUCH||d),n[c]=i===(e.MSPOINTER_TYPE_PEN||c),n[t]},reset:function(){this.pointers={}}},I=n.detection={gestures:[],current:null,previous:null,stopped:!1,startDetect:function(t,e){this.current||(this.stopped=!1,this.current={inst:t,startEvent:y.extend({},e),lastEvent:!1,lastCalcEvent:!1,futureCalcEvent:!1,lastCalcData:{},name:""},this.detect(e))},detect:function(t){if(this.current&&!this.stopped){t=this.extendEventData(t);var e=this.current.inst,i=e.options;return y.each(this.gestures,function(n){return!this.stopped&&e.enabled&&i[n.name]&&n.handler.call(n,t,e)===!1?(this.stopDetect(),!1):void 0},this),this.current&&(this.current.lastEvent=t),t.eventType==g&&this.stopDetect(),t}},stopDetect:function(){this.previous=y.extend({},this.current),this.current=null,this.stopped=!0},getCalculatedData:function(t,e,i,o,a){var s=this.current,r=!1,h=s.lastCalcEvent,l=s.lastCalcData;h&&t.timeStamp-h.timeStamp>n.CALCULATE_INTERVAL&&(e=h.center,i=t.timeStamp-h.timeStamp,o=t.center.clientX-h.center.clientX,a=t.center.clientY-h.center.clientY,r=!0),(t.eventType==m||t.eventType==p)&&(s.futureCalcEvent=t),(!s.lastCalcEvent||r)&&(l.velocity=y.getVelocity(i,o,a),l.angle=y.getAngle(e,t.center),l.direction=y.getDirection(e,t.center),s.lastCalcEvent=s.futureCalcEvent||t,s.futureCalcEvent=t),t.velocityX=l.velocity.x,t.velocityY=l.velocity.y,t.interimAngle=l.angle,t.interimDirection=l.direction},extendEventData:function(t){var e=this.current,i=e.startEvent,n=e.lastEvent||i;(t.eventType==m||t.eventType==p)&&(i.touches=[],y.each(t.touches,function(t){i.touches.push({clientX:t.clientX,clientY:t.clientY})}));var o=t.timeStamp-i.timeStamp,a=t.center.clientX-i.center.clientX,s=t.center.clientY-i.center.clientY;return this.getCalculatedData(t,n.center,o,a,s),y.extend(t,{startEvent:i,deltaTime:o,deltaX:a,deltaY:s,distance:y.getDistance(i.center,t.center),angle:y.getAngle(i.center,t.center),direction:y.getDirection(i.center,t.center),scale:y.getScale(i.touches,t.touches),rotation:y.getRotation(i.touches,t.touches)}),t},register:function(t){var i=t.defaults||{};return i[t.name]===e&&(i[t.name]=!0),y.extend(n.defaults,i,!0),t.index=t.index||1e3,this.gestures.push(t),this.gestures.sort(function(t,e){return t.index<e.index?-1:t.index>e.index?1:0}),this.gestures}};n.Instance=function(t,e){var o=this;i(),this.element=t,this.enabled=!0,y.each(e,function(t,i){delete e[i],e[y.toCamelCase(i)]=t}),this.options=y.extend(y.extend({},n.defaults),e||{}),this.options.behavior&&y.toggleBehavior(this.element,this.options.behavior,!0),this.eventStartHandler=v.onTouch(t,u,function(t){o.enabled&&t.eventType==u?I.startDetect(o,t):t.eventType==m&&I.detect(t)}),this.eventHandlers=[]},n.Instance.prototype={on:function(t,e){var i=this;return v.on(i.element,t,e,function(t){i.eventHandlers.push({gesture:t,handler:e})}),i},off:function(t,e){var i=this;return v.off(i.element,t,e,function(t){var n=y.inArray({gesture:t,handler:e});n!==!1&&i.eventHandlers.splice(n,1)}),i},trigger:function(t,e){e||(e={});var i=n.DOCUMENT.createEvent("Event");i.initEvent(t,!0,!0),i.gesture=e;var o=this.element;return y.hasParent(e.target,o)&&(o=e.target),o.dispatchEvent(i),this},enable:function(t){return this.enabled=t,this},dispose:function(){var t,e;for(y.toggleBehavior(this.element,this.options.behavior,!1),t=-1;e=this.eventHandlers[++t];)y.off(this.element,e.gesture,e.handler);return this.eventHandlers=[],v.off(this.element,o[u],this.eventStartHandler),null}},function(t){function e(e,n){var o=I.current;if(!(n.options.dragMaxTouches>0&&e.touches.length>n.options.dragMaxTouches))switch(e.eventType){case u:i=!1;break;case f:if(e.distance<n.options.dragMinDistance&&o.name!=t)return;var l=o.startEvent.center;if(o.name!=t&&(o.name=t,n.options.dragDistanceCorrection&&e.distance>0)){var d=Math.abs(n.options.dragMinDistance/e.distance);l.pageX+=e.deltaX*d,l.pageY+=e.deltaY*d,l.clientX+=e.deltaX*d,l.clientY+=e.deltaY*d,e=I.extendEventData(e)}(o.lastEvent.dragLockToAxis||n.options.dragLockToAxis&&n.options.dragLockMinDistance<=e.distance)&&(e.dragLockToAxis=!0);var c=o.lastEvent.direction;e.dragLockToAxis&&c!==e.direction&&(e.direction=y.isVertical(c)?e.deltaY<0?r:a:e.deltaX<0?s:h),i||(n.trigger(t+"start",e),i=!0),n.trigger(t,e),n.trigger(t+e.direction,e);var m=y.isVertical(e.direction);(n.options.dragBlockVertical&&m||n.options.dragBlockHorizontal&&!m)&&e.preventDefault();break;case p:i&&e.changedLength<=n.options.dragMaxTouches&&(n.trigger(t+"end",e),i=!1);break;case g:i=!1}}var i=!1;n.gestures.Drag={name:t,index:50,handler:e,defaults:{dragMinDistance:10,dragDistanceCorrection:!0,dragMaxTouches:1,dragBlockHorizontal:!1,dragBlockVertical:!1,dragLockToAxis:!1,dragLockMinDistance:25}}}("drag"),n.gestures.Gesture={name:"gesture",index:1337,handler:function(t,e){e.trigger(this.name,t)}},function(t){function e(e,n){var o=n.options,a=I.current;switch(e.eventType){case u:clearTimeout(i),a.name=t,i=setTimeout(function(){a&&a.name==t&&n.trigger(t,e)},o.holdTimeout);break;case f:e.distance>o.holdThreshold&&clearTimeout(i);break;case p:clearTimeout(i)}}var i;n.gestures.Hold={name:t,index:10,defaults:{holdTimeout:500,holdThreshold:2},handler:e}}("hold"),n.gestures.Release={name:"release",index:1/0,handler:function(t,e){t.eventType==p&&e.trigger(this.name,t)}},n.gestures.Swipe={name:"swipe",index:40,defaults:{swipeMinTouches:1,swipeMaxTouches:1,swipeVelocityX:.6,swipeVelocityY:.6},handler:function(t,e){if(t.eventType==p){var i=t.touches.length,n=e.options;if(i<n.swipeMinTouches||i>n.swipeMaxTouches)return;(t.velocityX>n.swipeVelocityX||t.velocityY>n.swipeVelocityY)&&(e.trigger(this.name,t),e.trigger(this.name+t.direction,t))}}},function(t){function e(e,n){var o,a,s=n.options,r=I.current,h=I.previous;switch(e.eventType){case u:i=!1;break;case f:i=i||e.distance>s.tapMaxDistance;break;case g:"touchcancel"!=e.srcEvent.type&&e.deltaTime<s.tapMaxTime&&!i&&(o=h&&h.lastEvent&&e.timeStamp-h.lastEvent.timeStamp,a=!1,h&&h.name==t&&o&&o<s.doubleTapInterval&&e.distance<s.doubleTapDistance&&(n.trigger("doubletap",e),a=!0),(!a||s.tapAlways)&&(r.name=t,n.trigger(r.name,e)))}}var i=!1;n.gestures.Tap={name:t,index:100,handler:e,defaults:{tapMaxTime:250,tapMaxDistance:10,tapAlways:!0,doubleTapDistance:20,doubleTapInterval:300}}}("tap"),n.gestures.Touch={name:"touch",index:-1/0,defaults:{preventDefault:!1,preventMouse:!1},handler:function(t,e){return e.options.preventMouse&&t.pointerType==l?void t.stopDetect():(e.options.preventDefault&&t.preventDefault(),void(t.eventType==m&&e.trigger("touch",t)))}},function(t){function e(e,n){switch(e.eventType){case u:i=!1;break;case f:if(e.touches.length<2)return;var o=Math.abs(1-e.scale),a=Math.abs(e.rotation);if(o<n.options.transformMinScale&&a<n.options.transformMinRotation)return;I.current.name=t,i||(n.trigger(t+"start",e),i=!0),n.trigger(t,e),a>n.options.transformMinRotation&&n.trigger("rotate",e),o>n.options.transformMinScale&&(n.trigger("pinch",e),n.trigger("pinch"+(e.scale<1?"in":"out"),e));break;case p:i&&e.changedLength<2&&(n.trigger(t+"end",e),i=!1)}}var i=!1;n.gestures.Transform={name:t,index:45,defaults:{transformMinScale:.01,transformMinRotation:1},handler:e}}("transform"),"function"==typeof define&&define.amd?define(function(){return n}):"undefined"!=typeof module&&module.exports?module.exports=n:t.Hammer=n}(window),!function(t,e){"use strict";function i(t,i){Date.now||(Date.now=function(){return(new Date).getTime()}),t.utils.each(["on","off"],function(n){t.utils[n]=function(t,o,a){i(t)[n](o,function(t){var n=i.extend({},t.originalEvent,t);n.button===e&&(n.button=t.which-1),a.call(this,n)})}}),t.Instance.prototype.trigger=function(t,e){var n=i(this.element);return n.has(e.target).length&&(n=i(e.target)),n.trigger({type:t,gesture:e})},i.fn.hammer=function(e){return this.each(function(){var n=i(this),o=n.data("hammer");o?o&&e&&t.utils.extend(o.options,e):n.data("hammer",new t(this,e||{}))})}}"function"==typeof define&&define.amd?define(["hammerjs","jquery"],i):i(t.Hammer,t.jQuery||t.Zepto)}(window);var WayfinderAPI={LOCATION:"//api.3dwayfinder.com/",PROJECT:!1,getJSON:function(t,e){Logistics.getJSON(t,e).error(function(t){console&&console.log&&console.log("Failed to get JSON: "+JSON.stringify(t))})},getURL:function(t,e,i){if(WayfinderAPI.PROJECT===!1)throw"No project opened! Call WayfinderAPI.open(<project name>);";return i=i||[],[WayfinderAPI.LOCATION,"public",WayfinderAPI.PROJECT,t,e].concat(i).join("/")},open:function(t){WayfinderAPI.PROJECT=t}};WayfinderAPI["2d"]={},WayfinderAPI["3d"]={},WayfinderAPI.access={},WayfinderAPI.advertisements={},WayfinderAPI.building={},WayfinderAPI.guitranslations={},WayfinderAPI.images={},WayfinderAPI.languages={},WayfinderAPI.lights={},WayfinderAPI.locationgroups={},WayfinderAPI.locations={},WayfinderAPI.materials={},WayfinderAPI.models={},WayfinderAPI.navigation={},WayfinderAPI.poisettings={},WayfinderAPI.settings={},WayfinderAPI.statistics={},WayfinderAPI.templates={},WayfinderAPI.textures={},WayfinderAPI["2d"].edges=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","edges",[]),t)},WayfinderAPI["2d"].edges.url=function(){return WayfinderAPI.getURL("2d","edges",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].image=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","image",[t]),e)},WayfinderAPI["2d"].image.url=function(){return WayfinderAPI.getURL("2d","image",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].lod=function(t,e,i,n,o){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","lod",[t,e,i,n]),o)},WayfinderAPI["2d"].lod.url=function(){return WayfinderAPI.getURL("2d","lod",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].lodcount=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","lodcount",[]),t)},WayfinderAPI["2d"].lodcount.url=function(){return WayfinderAPI.getURL("2d","lodcount",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].nodes=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","nodes",[]),t)},WayfinderAPI["2d"].nodes.url=function(){return WayfinderAPI.getURL("2d","nodes",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].overlays=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","overlays",[]),t)},WayfinderAPI["2d"].overlays.url=function(){return WayfinderAPI.getURL("2d","overlays",Array.prototype.slice.call(arguments,0))},WayfinderAPI["3d"].scene=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("3d","scene",[]),t)},WayfinderAPI["3d"].scene.url=function(){return WayfinderAPI.getURL("3d","scene",Array.prototype.slice.call(arguments,0))},WayfinderAPI.access.template=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("access","template",[t]),e)},WayfinderAPI.access.template.url=function(){return WayfinderAPI.getURL("access","template",Array.prototype.slice.call(arguments,0))},WayfinderAPI.advertisements.all=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("advertisements","all",[]),t)},WayfinderAPI.advertisements.all.url=function(){return WayfinderAPI.getURL("advertisements","all",Array.prototype.slice.call(arguments,0))},WayfinderAPI.advertisements.data=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("advertisements","data",[t]),e)},WayfinderAPI.advertisements.data.url=function(){return WayfinderAPI.getURL("advertisements","data",Array.prototype.slice.call(arguments,0))},WayfinderAPI.advertisements.frames=function(t,e,i,n){WayfinderAPI.getJSON(WayfinderAPI.getURL("advertisements","frames",[t,e,i]),n)},WayfinderAPI.advertisements.frames.url=function(){return WayfinderAPI.getURL("advertisements","frames",Array.prototype.slice.call(arguments,0))},WayfinderAPI.building.levels=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("building","levels",[]),t)},WayfinderAPI.building.levels.url=function(){return WayfinderAPI.getURL("building","levels",Array.prototype.slice.call(arguments,0))},WayfinderAPI.building.location=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("building","location",[]),t)},WayfinderAPI.building.location.url=function(){return WayfinderAPI.getURL("building","location",Array.prototype.slice.call(arguments,0))},WayfinderAPI.guitranslations.get=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("guitranslations","get",[]),t)},WayfinderAPI.guitranslations.get.url=function(){return WayfinderAPI.getURL("guitranslations","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.images.checkImage=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("images","checkImage",[t]),e)},WayfinderAPI.images.checkImage.url=function(){return WayfinderAPI.getURL("images","checkImage",Array.prototype.slice.call(arguments,0))},WayfinderAPI.images.get=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("images","get",[t]),e)},WayfinderAPI.images.get.url=function(){return WayfinderAPI.getURL("images","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.images.thumbnail=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("images","thumbnail",[t]),e)},WayfinderAPI.images.thumbnail.url=function(){return WayfinderAPI.getURL("images","thumbnail",Array.prototype.slice.call(arguments,0))},WayfinderAPI.languages.get=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("languages","get",[]),t)},WayfinderAPI.languages.get.url=function(){return WayfinderAPI.getURL("languages","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.languages.translation=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("languages","translation",[t]),e)},WayfinderAPI.languages.translation.url=function(){return WayfinderAPI.getURL("languages","translation",Array.prototype.slice.call(arguments,0))},WayfinderAPI.lights.get=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("lights","get",[]),t)},WayfinderAPI.lights.get.url=function(){return WayfinderAPI.getURL("lights","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locationgroups.get=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("locationgroups","get",[]),t)},WayfinderAPI.locationgroups.get.url=function(){return WayfinderAPI.getURL("locationgroups","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.byfloor=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","byfloor",[]),t)},WayfinderAPI.locations.byfloor.url=function(){return WayfinderAPI.getURL("locations","byfloor",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.bygroup=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","bygroup",[]),t)},WayfinderAPI.locations.bygroup.url=function(){return WayfinderAPI.getURL("locations","bygroup",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.bynode=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","bynode",[t]),e)},WayfinderAPI.locations.bynode.url=function(){return WayfinderAPI.getURL("locations","bynode",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.get=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","get",[]),t)},WayfinderAPI.locations.get.url=function(){return WayfinderAPI.getURL("locations","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.location=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","location",[t]),e)},WayfinderAPI.locations.location.url=function(){return WayfinderAPI.getURL("locations","location",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.tags=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","tags",[]),t)},WayfinderAPI.locations.tags.url=function(){return WayfinderAPI.getURL("locations","tags",Array.prototype.slice.call(arguments,0))},WayfinderAPI.materials.get=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("materials","get",[]),t)},WayfinderAPI.materials.get.url=function(){return WayfinderAPI.getURL("materials","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.materials.textureMaterialNames=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("materials","textureMaterialNames",[t]),e)},WayfinderAPI.materials.textureMaterialNames.url=function(){return WayfinderAPI.getURL("materials","textureMaterialNames",Array.prototype.slice.call(arguments,0))},WayfinderAPI.materials.textures=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("materials","textures",[t]),e)},WayfinderAPI.materials.textures.url=function(){return WayfinderAPI.getURL("materials","textures",Array.prototype.slice.call(arguments,0))},WayfinderAPI.materials.uniforms=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("materials","uniforms",[t]),e)},WayfinderAPI.materials.uniforms.url=function(){return WayfinderAPI.getURL("materials","uniforms",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.all=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","all",[]),t)},WayfinderAPI.models.all.url=function(){
return WayfinderAPI.getURL("models","all",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.allmeshes=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","allmeshes",[]),t)},WayfinderAPI.models.allmeshes.url=function(){return WayfinderAPI.getURL("models","allmeshes",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.get=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","get",[]),t)},WayfinderAPI.models.get.url=function(){return WayfinderAPI.getURL("models","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.instances=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","instances",[]),t)},WayfinderAPI.models.instances.url=function(){return WayfinderAPI.getURL("models","instances",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.json=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","json",[t]),e)},WayfinderAPI.models.json.url=function(){return WayfinderAPI.getURL("models","json",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.meshes=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","meshes",[t]),e)},WayfinderAPI.models.meshes.url=function(){return WayfinderAPI.getURL("models","meshes",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.meshesbyfloor=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","meshesbyfloor",[]),t)},WayfinderAPI.models.meshesbyfloor.url=function(){return WayfinderAPI.getURL("models","meshesbyfloor",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.model=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","model",[t]),e)},WayfinderAPI.models.model.url=function(){return WayfinderAPI.getURL("models","model",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.allAttributes=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","allAttributes",[]),t)},WayfinderAPI.navigation.allAttributes.url=function(){return WayfinderAPI.getURL("navigation","allAttributes",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.attributes=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","attributes",[t]),e)},WayfinderAPI.navigation.attributes.url=function(){return WayfinderAPI.getURL("navigation","attributes",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.edges=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","edges",[]),t)},WayfinderAPI.navigation.edges.url=function(){return WayfinderAPI.getURL("navigation","edges",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.node=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","node",[t]),e)},WayfinderAPI.navigation.node.url=function(){return WayfinderAPI.getURL("navigation","node",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.nodes=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","nodes",[]),t)},WayfinderAPI.navigation.nodes.url=function(){return WayfinderAPI.getURL("navigation","nodes",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.nodesbytype=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","nodesbytype",[t]),e)},WayfinderAPI.navigation.nodesbytype.url=function(){return WayfinderAPI.getURL("navigation","nodesbytype",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.get=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","get",[]),t)},WayfinderAPI.poisettings.get.url=function(){return WayfinderAPI.getURL("poisettings","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.getAllPOISettings=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","getAllPOISettings",[]),t)},WayfinderAPI.poisettings.getAllPOISettings.url=function(){return WayfinderAPI.getURL("poisettings","getAllPOISettings",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.getText=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","getText",[t]),e)},WayfinderAPI.poisettings.getText.url=function(){return WayfinderAPI.getURL("poisettings","getText",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.getTexts=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","getTexts",[]),t)},WayfinderAPI.poisettings.getTexts.url=function(){return WayfinderAPI.getURL("poisettings","getTexts",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.map=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","map",[]),t)},WayfinderAPI.poisettings.map.url=function(){return WayfinderAPI.getURL("poisettings","map",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.setting=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","setting",[t]),e)},WayfinderAPI.poisettings.setting.url=function(){return WayfinderAPI.getURL("poisettings","setting",Array.prototype.slice.call(arguments,0))},WayfinderAPI.settings.get=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("settings","get",[]),t)},WayfinderAPI.settings.get.url=function(){return WayfinderAPI.getURL("settings","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.settings.getText=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("settings","getText",[t]),e)},WayfinderAPI.settings.getText.url=function(){return WayfinderAPI.getURL("settings","getText",Array.prototype.slice.call(arguments,0))},WayfinderAPI.settings.getTexts=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("settings","getTexts",[]),t)},WayfinderAPI.settings.getTexts.url=function(){return WayfinderAPI.getURL("settings","getTexts",Array.prototype.slice.call(arguments,0))},WayfinderAPI.settings.map=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("settings","map",[]),t)},WayfinderAPI.settings.map.url=function(){return WayfinderAPI.getURL("settings","map",Array.prototype.slice.call(arguments,0))},WayfinderAPI.settings.setting=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("settings","setting",[t]),e)},WayfinderAPI.settings.setting.url=function(){return WayfinderAPI.getURL("settings","setting",Array.prototype.slice.call(arguments,0))},WayfinderAPI.statistics.click=function(t,e,i,n){WayfinderAPI.getJSON(WayfinderAPI.getURL("statistics","click",[t,e,i]),n)},WayfinderAPI.statistics.click.url=function(){return WayfinderAPI.getURL("statistics","click",Array.prototype.slice.call(arguments,0))},WayfinderAPI.statistics.device=function(t,e,i,n){WayfinderAPI.getJSON(WayfinderAPI.getURL("statistics","device",[t,e,i]),n)},WayfinderAPI.statistics.device.url=function(){return WayfinderAPI.getURL("statistics","device",Array.prototype.slice.call(arguments,0))},WayfinderAPI.statistics.endSession=function(t,e,i){WayfinderAPI.getJSON(WayfinderAPI.getURL("statistics","endSession",[t,e]),i)},WayfinderAPI.statistics.endSession.url=function(){return WayfinderAPI.getURL("statistics","endSession",Array.prototype.slice.call(arguments,0))},WayfinderAPI.statistics.search=function(t,e,i,n){WayfinderAPI.getJSON(WayfinderAPI.getURL("statistics","search",[t,e,i]),n)},WayfinderAPI.statistics.search.url=function(){return WayfinderAPI.getURL("statistics","search",Array.prototype.slice.call(arguments,0))},WayfinderAPI.statistics.startSession=function(t,e,i,n,o,a){WayfinderAPI.getJSON(WayfinderAPI.getURL("statistics","startSession",[t,e,i,n,o]),a)},WayfinderAPI.statistics.startSession.url=function(){return WayfinderAPI.getURL("statistics","startSession",Array.prototype.slice.call(arguments,0))},WayfinderAPI.templates.css=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("templates","css",[t]),e)},WayfinderAPI.templates.css.url=function(){return WayfinderAPI.getURL("templates","css",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.count=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","count",[]),t)},WayfinderAPI.textures.count.url=function(){return WayfinderAPI.getURL("textures","count",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.map=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","map",[]),t)},WayfinderAPI.textures.map.url=function(){return WayfinderAPI.getURL("textures","map",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.mipmap=function(t,e,i){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","mipmap",[t,e]),i)},WayfinderAPI.textures.mipmap.url=function(){return WayfinderAPI.getURL("textures","mipmap",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.names=function(t){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","names",[]),t)},WayfinderAPI.textures.names.url=function(){return WayfinderAPI.getURL("textures","names",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.texture=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","texture",[t]),e)},WayfinderAPI.textures.texture.url=function(){return WayfinderAPI.getURL("textures","texture",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.texturebyid=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","texturebyid",[t]),e)},WayfinderAPI.textures.texturebyid.url=function(){return WayfinderAPI.getURL("textures","texturebyid",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.thumbnail=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","thumbnail",[t]),e)},WayfinderAPI.textures.thumbnail.url=function(){return WayfinderAPI.getURL("textures","thumbnail",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.thumbnailbyid=function(t,e){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","thumbnailbyid",[t]),e)},WayfinderAPI.textures.thumbnailbyid.url=function(){return WayfinderAPI.getURL("textures","thumbnailbyid",Array.prototype.slice.call(arguments,0))};var Wayfinder=Class.extend({init:function(t,e){t&&t instanceof WayfinderOptions||(t=new WayfinderOptions),e||(e=new WayfinderFactory(this)),this.factory=e,this.setOptions(t),this.settings=new Settings,this.statistics=new WFStatistics(this),this.firstFinishedLoading=!1,this.debugLog=!1,this.kiosk=!1,t.debugLog&&DebugLog&&"DebugLog"==typeof DebugLog&&(this.debugLog=new DebugLog(t.debugLog)),Logistics.onStageProgress(ClassCallback(this,this.onStageProgress)),Logistics.onProgress(ClassCallback(this,this.onProgress)),this.languages={},this.pois={},this.poisArray=[],this.poiGroups={},this.nodes={},this.edges={},this.attributes={},this.poisettings=new Settings,this.poiAdvertisements={},this.advertisements={},this.translator=new Translator(this.options.language,{}),this.building=null,this.firstLanguageChange=!0,this.search=new WayfinderSearch(this),this.accessibility=""},cbOnPOIClick:function(){},cbOnDataLoaded:function(){},cbOnProgress:function(){},cbOnStageProgress:function(){},cbOnLanguageChange:function(){},cbOnBeforeFloorChange:function(){},cbOnFloorChange:function(){},cbOnZoomChange:function(){},cbOnPathStep:function(){},cbOnPathFinished:function(){},cbOnTouch:function(){},cbOnMapUpdate:function(){},cbOnMapReady:function(){},finishedLoading:function(){this.firstFinishedLoading||(this.firstFinishedLoading=!0,this.onDataLoaded())},setOptions:function(t){this.options=t,this.options.project=this.readProjectName(),this.options.loadFromURL()},setStyle:function(t){$("head").append('<link rel="stylesheet" type="text/css" href="{0}">'.format(WayfinderAPI.templates.css.url(t)))},open:function(t){"undefined"!=typeof t&&(this.options.project=t),WayfinderAPI.open(this.options.project),this.startLoading(),log("Open",this.options.project)},readProjectName:function(){for(var t=document.location.pathname,e=t.split("/"),i=0;i<e.length;i++)if("projects"==e[i]&&e.length>i+1)return e[i+1];return this.options.project},getLayout:function(){for(var t=document.location.pathname,e=t.split("/"),i=0;i<e.length;i++)if("projects"==e[i]&&e.length>i+2)return e[i+2];return"default"},log:function(){this.debugLog&&this.debugLog.logArray(this.log.arguments)},getProject:function(){return this.options.project},getAPILocation:function(){return WayfinderAPI&&WayfinderAPI.LOCATION?WayfinderAPI.LOCATION:this.options.apiLocation},setKiosk:function(t){this.options.kiosk=t},getKiosk:function(){return this.options.kiosk},getKioskNode:function(){return this.options.kiosk&&this.options.kiosk in this.nodes?this.nodes[this.options.kiosk]:!1},showPath:function(){},showKiosk:function(){},showFloor:function(t){this.cbOnFloorChange&&"function"==typeof this.cbOnFloorChange&&this.cbOnFloorChange(t)},getLanguage:function(){return this.translator.getLanguage()},setLanguage:function(t){this.translator.translate(t),"function"==typeof this.cbOnLanguageChange&&this.cbOnLanguageChange(t)},startLoading:function(){Logistics.getJSON(WayfinderAPI.getURL("settings","get",[]),null,ClassCallback(this,this.onSettingsLoaded),{stage:"settings"}),Logistics.getJSON(WayfinderAPI.getURL("poisettings","getAllPOISettings",[]),null,ClassCallback(this,this.onPOISettingsLoaded),{stage:"settings"}),Logistics.getJSON(WayfinderAPI.getURL("languages","get",[]),null,ClassCallback(this,this.onLanguagesLoaded),{stage:"settings"})},loadPOIIcons:function(){if(this.pois){var t=null;for(var e in this.pois)this.pois[e].image_id&&0!==this.pois[e].image_id&&this.pois[e].alwaysVisible&&(t=Logistics.getImage(WayfinderAPI.getURL("images","get",[this.pois[e].image_id]),null,ClassCallback(this.pois[e],this.pois[e].setIcon),{stage:"locations"}))}},loadSecondaryResources:function(){function t(){e.loadHiddenPOIIcons()}var e=this;setTimeout(t,1e3)},loadHiddenPOIIcons:function(){if(this.pois)for(var t in this.pois)this.pois[t].image_id&&0!==this.pois[t].image_id&&!this.pois[t].alwaysVisible&&Logistics.getImage(WayfinderAPI.getURL("images","thumbnail",[this.pois[t].image_id]),ClassCallback(this.pois[t],this.pois[t].setIcon))},onAdvertisementsLoaded:function(t){this.advertisements=t.data},onSettingsLoaded:function(t){t.data&&(this.settings.data=t.data,this.building=this.factory.createBuilding(this.settings.data),this.settings.data["language.default"]&&(this.options.language=this.settings.data["language.default"],this.setLanguage(this.options.language)),this.settings.data["kiosk.default"]&&(this.setKiosk(this.settings.getInt("kiosk.default",0)),log("setKiosk",this.options.kiosk)),this.options.loadFromURL())},onPOISettingsLoaded:function(t){t.data&&(this.poisettings.data=t.data,this.options.loadFromURL())},onLanguagesLoaded:function(t){if(t.data){var e=t.data;for(var i in e)this.languages[i]=new Language(e[i],e),i.toLowerCase()==this.options.language.toLowerCase()&&(this.translator.language=i);this.translator.translate(),Logistics.getJSON(WayfinderAPI.getURL("guitranslations","get",[]),null,ClassCallback(this,this.createTranslations),{stage:"settings"}),Logistics.getJSON(WayfinderAPI.getURL("building","levels",[]),null,ClassCallback(this,this.onFloorsLoaded),{stage:"settings"})}},onFloorsLoaded:function(t){var e=t.data;this.factory.createFloors(e),Logistics.getMultiple({nodes:{url:WayfinderAPI.getURL("navigation","nodes",[]),type:"json"},attributes:{url:WayfinderAPI.getURL("navigation","allAttributes",[]),type:"json"},pois:{url:WayfinderAPI.getURL("locations","get",[]),type:"json"},floor_pois:{url:WayfinderAPI.getURL("locations","byfloor",[]),type:"json"},edges:{url:WayfinderAPI.getURL("navigation","edges",[]),type:"json"}},ClassCallback(this,this.onPOIsLoaded),{stage:"settings"})},onPOIsLoaded:function(t){var e=t.nodes.data,i=t.attributes,n=t.pois.data,o=t.floor_pois.data,a=t.edges.data;Logistics.getMultiple({groups:{url:WayfinderAPI.getURL("locationgroups","get",[]),type:"json"},pois_in_groups:{url:WayfinderAPI.getURL("locations","bygroup",[]),type:"json"},tags:{url:WayfinderAPI.getURL("locations","tags",[]),type:"json"}},ClassCallback(this,this.onTextDataLoaded),{stage:"locations"}),Logistics.getJSON(WayfinderAPI.advertisements.all.url(),ClassCallback(this,this.onAdvertisementsLoaded)),this.factory.createNodes(e),this.factory.createAttributes(i),this.factory.createPOIs(n),this.factory.createEdges(a),this.factory.addPOIsToFloor(o)},onTextDataLoaded:function(t){this.loadPOIIcons();var e=t.tags.data,i=t.groups.data,n=t.pois_in_groups.data;this.factory.createGroups(i,n),this.factory.createTags(e),this.factory.filterPOIs(this.options.filterPOIs.trim().split(","))},onDataLoaded:function(){this.setKiosk(this.options.kiosk),this.statistics.start(),this.loadSecondaryResources(),this.cbOnProgress(100),this.cbOnDataLoaded()},createTranslations:function(t){this.translator&&t&&this.translator.setTranslations(t.data)},onProgress:function(t){"function"==typeof this.cbOnProgress&&this.cbOnProgress(t)},onStageProgress:function(t,e){"function"==typeof this.cbOnStageProgress&&this.cbOnStageProgress(t,e)},resize:function(){var t=document.getElementById(this.options.map),e=window.getComputedStyle(t,null),i=parseInt(e.width),n=parseInt(e.height);t.setAttribute("width",i+"px"),t.setAttribute("height",n+"px")},onPOIClick:function(t){"function"==typeof this.cbOnPOIClick&&this.cbOnPOIClick(t)},onZoomChange:function(t){"function"==typeof this.cbOnZoomChange&&this.cbOnZoomChange(t)},setZoom:function(){},zoomIn:function(){},zoomOut:function(){},pathToText:function(){},textPathSimplification:function(t){function e(t){return t>=45&&135>t?"right":t>=135&&225>t?"around":t>=225&&315>t?"left":!1}var i={},n="generic portal kiosk landmark";if(i.distance=0,i.steps=[],t&&t.length>0){for(var o=!1,a=t[t.length-1].bNode,s=0,r=0;r<t.length;r++)i.distance+=t[r].distance,s+=t[r].distance,o=e(t[r].angle),t[r].type&&"landmark"==t[r].type&&(t[r].bNode&&t[r].bNode.pois&&t[r].bNode.pois.length>0?i.steps.push({landmark:t[r].bNode.pois,endNode:t[r].bNode,startNode:a,"in":s}):t[r].aNode&&t[r].aNode.pois&&t[r].aNode.pois.length>0&&i.steps.push({landmark:t[r].aNode.pois,endNode:t[r].aNode,startNode:a,"in":s})),o&&(("string"!=typeof t[r].type||-1!=n.indexOf(t[r].type))&&(s>0&&i.steps.push({walk:s/100,endNode:t[r].bNode,startNode:a}),i.steps.push({turn:o,endNode:t[r].bNode,startNode:a,"in":s})),a=t[r].bNode,s=0),t[r].type&&-1==n.indexOf(t[r].type)&&(r>0&&r<t.length-1&&t[r].type!==t[r+1].type&&(s>0&&i.steps.push({walk:lastDistanc/100,endNode:t[r].bNode,startNode:a}),i.steps.push({use:t[r].type,endNode:t[r].bNode,startNode:a,"in":s}),a=t[r].bNode),s=0),t[r].go_to_floor&&(s>0&&i.steps({walk:s/100,endNode:t[r].bNode,startNode:a}),s=0,i.steps.push({go_to_floor:t[r].go_to_floor,endNode:t[r].bNode,startNode:a}),a=t[r].bNode);s>0&&i.steps.push({walk:s/100,endNode:t[t.length-1].bNode,startNode:a})}return i},getPOIWithExternalId:function(t){for(var e in this.pois)if(this.pois[e].room_id==t)return this.pois[e];return!1},getNearestPOI:function(){},restoreDefaultState:function(){this.options.language&&this.setLanguage(this.options.language),this.clearHighlights(),this.showKiosk()},showScreensaver:function(){},hideScreensaver:function(){},setHighlights:function(){},clearHighlights:function(){},onSetLanguage:function(){},getLanguages:function(){return this.languages},getPOIs:function(){return this.pois},getPOIsArray:function(){return this.poisArray},getPOIGroups:function(){return this.poiGroups},getNodes:function(){return this.nodes},getEdges:function(){return this.edges},clearPath:function(){},zoomOnPathSegment:function(){}}),WayfinderFactory=Class.extend({init:function(t){this.wayfinder=t},createFloors:function(t){if(t&&this.wayfinder.building)for(var e in t)this.wayfinder.building.addFloor(this.createFloor(t[e],this.wayfinder.languages))},createNodes:function(t){if(t)for(var e=this.wayfinder.settings.getInt("kiosk.default",0),i=this.wayfinder.building.getFloors(),n=0;n<t.length;n++){var o=this.createNode(t[n]);o&&(this.wayfinder.nodes[t[n].id]=o,o.floor_id in i&&i[o.floor_id].addNode(o),t[n].id==e&&(this.wayfinder.kiosk=o))}},createAttributes:function(t){t&&(this.wayfinder.attributes=t)},createPOIs:function(t){for(var e=0;e<t.length;e++){var i=this.createPOI(t[e],this.wayfinder.languages);this.wayfinder.pois[t[e].id]=i,this.wayfinder.poisArray.push(i),i.node_id in this.wayfinder.nodes&&this.wayfinder.nodes[i.node_id].addPOI(i),this.wayfinder.poisettings&&this.wayfinder.poisettings.data&&this.wayfinder.poisettings.data[i.id]&&(i.settings.data=this.wayfinder.poisettings.data[i.id])}},createTags:function(t){if(t)for(var e in t){var i=t[e],n=this.wayfinder.pois[i.poi_id];n&&n.setTags(i.tags)}},filterPOIs:function(t){if(t&&t.length>0){var e,i="";for(var n in t)if(i=t[n].trim(),i&&""!==i)for(var o in this.wayfinder.pois)e=this.wayfinder.pois[o],e.setShowInMenu(!1),e.getTags().indexOf(i)>-1&&e.setShowInMenu(!0)}},createGroups:function(t,e){if(e&&t){var i,n;for(n in t)i=this.createPOIGroup(t[n],this.wayfinder.languages),this.wayfinder.poiGroups[i.getID()]=i;for(var o in e){n=e[o];for(var a in n){var s=this.wayfinder.pois[n[a]];i=this.wayfinder.poiGroups[o],s&&i&&(i.addPOI(s),s.addGroup(i))}}}},createAdvertisements:function(t){if(t)for(var e in t){var i=t[e],n=this.wayfinder.pois[i.poi_id];if(n){var o=this.createPOIAdvertisement(n,i,this.wayfinder.languages);this.wayfinder.poiAdvertisements[i.id]=o,n.addAdvertisement(o)}}},addPOIsToFloor:function(t){for(var e in t){var i=this.wayfinder.building.getFloors();if(e in i){var n=i[e];for(var o in t[e])t[e][o]in this.wayfinder.pois&&n.addPOI(this.wayfinder.pois[t[e][o]])}}},createEdges:function(t){this.wayfinder.edges=t},createBuilding:function(t){return new Building(t)},createFloor:function(t,e){return new Floor(t,e)},createNode:function(t){return new NavigationNode(t)},createPOI:function(t,e){return new POI(t,e)},createPOIGroup:function(t,e){return new POIGroup(t,e)},createPOIAdvertisement:function(t,e,i){return new POIAdvertisement(t,e,i)}}),WayfinderOptions=Class.extend({init:function(){this.application="wayfinder",this.map="map",this.project="demo",this.kiosk=!1,this.debugLog=!1,this.debugPOIs=!1,this.debugTranslations=!1,this.drawKioskIcon=!0,this.apiLocation="../../api/",this.language="en",this.disablePathDrawing=!1,this.searchScroreLimiter=3,this.searchMinimumScrore=10,this.filterPOIs="",this.factory=new WayfinderFactory},loadFromURL:function(){if(location.hash.length>=2){var t=unescape(location.hash.substring(1)).split("#");if(t.length>=1){var e=JSON.parse(t[0]);for(var i in e)log("Overriding option: "+i+"="+e[i]),this[i]=e[i],"kiosk"===i&&(this["kiosk.default"]=e[i])}}}}),DebugLog=Class.extend({init:function(t){this.enabled=t,this.element=$("#log .content"),this.shown=!1,this.enabled&&$("#log").show(),$("#log .toggle").click(function(){$("#log .content").toggle()})},logArray:function(t){var e=$("<div></div>");for(var i in t)e.append(JSON.stringify(t[i])+", ");this.element.prepend(e)}}),ArrayUtility=Class.extend({init:function(t){if(t instanceof Object){var e=t;this.data=[];for(var i in e)this.data.push(e[i])}else{if(!(t instanceof Array))throw"Argument objectOrArray must be an object or array";this.data=t}},get:function(){return this.data},sort:function(t){var e=function(e,i){return t(e,i)?1:t(i,e)?-1:0};return this.data.sort(e),this.data}}),Building=Class.extend({init:function(t){this.name=t["building.name"],this.address=t["building.address"],this.link=new Translations(t["building.link"]),this.description=new Translations(t["building.description"]),this.logoID=t["building.logo"],this.backgroundID=t["building.background"],this.floors={}},addFloor:function(t){this.floors[t.id]=t},removeFloor:function(t){delete this.floors[t.id]},getFloors:function(){return this.floors},getSortedFloors:function(){var t=new ArrayUtility(this.floors);return t.sort(function(t,e){return t.index<e.index})}}),Settings=Class.extend({init:function(){this.data={}},has:function(t){return t in this.data},get:function(t,e,i){return i&&i.settings.data&&i.settings.data[t]?i.settings.data[t].value:t in this.data?this.data[t]:e},getInt:function(t,e){return parseInt(this.get(t,e))},getFloat:function(t,e,i){return parseFloat(this.get(t,e,i))},getColor:function(t,e,i){return(new Color).fromHex(this.get(t,e,i))},getBoolean:function(t,e,i){return this.get(t,e,i)===!0},getModel:function(t,e,i){var n=this.getInt(t,0,i);return 0===n?e:n},set:function(t,e){this.data[t]=e},override:function(t){for(var e in t)this.data[e]=t[e]}}),NavigationNode=Class.extend({init:function(t){this.id=t.id,this.floor_id=t.level_id,this.type=t.type,this.position=vec3.fromValues(-parseFloat(t.x),parseFloat(t.y),parseFloat(t.z)),this.rotation=vec3.fromValues(parseFloat(t.rotation_x),parseFloat(t.rotation_y),parseFloat(t.rotation_z)),this.floor=!1,this.pois=[],this.weight=0,t.weight&&(this.weight=parseFloat(t.weight)),this.zoom=0,t.zoom&&(this.zoom=parseFloat(t.zoom))},setFloor:function(t){t instanceof Floor&&t.id==this.floor_id&&(this.floor=t)},addPOI:function(t){t instanceof POI&&t.node_id==this.id&&(t.setNode(this),this.pois.push(t))},getID:function(){return this.id},getFloor:function(){return this.floor},getPOIs:function(){return this.pois}}),Floor=Class.extend({init:function(t,e){this.id=parseInt(t.id,10),this.name_id=parseInt(t.name_id,10),this.model_id=parseInt(t.model_id,10),this.index=parseInt(t.index,10),this.y=parseFloat(t.y,10),this.lightmap_id=parseInt(t.lightmap_id,10),this.showInMenu=0!==parseInt(t.show_in_menu,10),this.names=new Translations;for(var i in e)this.names.set(i,t[i]);this.pois=[],this.nodes=[]},getID:function(){return this.id},getName:function(t){return this.names.get(t)},getNames:function(){return this.names},addPOI:function(t){t instanceof POI&&(t.setFloor(this),this.pois.push(t))},addNode:function(t){t instanceof NavigationNode&&t.floor_id==this.id&&(t.setFloor(this),this.nodes.push(t))},getPOIs:function(){return this.pois},getNodes:function(){return this.nodes},getShowInMenu:function(){return this.showInMenu}}),POI=Class.extend({init:function(t,e){this.id=parseInt(t.id),this.type=t.type,this.node_id=parseInt(t.node_id),this.mesh_id=parseInt(t.mesh_id),this.room_id=t.room_id,this.image_id=parseInt(t.image_id),this.icon=null,this.background_id=parseInt(t.background_id),this.background=null,this.showInMenu=0!=parseInt(t.show_in_menu),this.alwaysVisible=0!=parseInt(t.always_visible),this.settings={},this.names=new Translations,this.descriptions=new Translations,this.hasName=!1;for(var i in e)this.names.set(i,t["names_"+i]),this.descriptions.set(i,t["descriptions_"+i]),this.names.get(i).length>0&&(this.hasName=!0);this.floor=!1,this.node=!1,this.groups=[],this.advertisements=[],this.groupNames={},this.tags=""},getID:function(){return this.id},getName:function(t){return this.names.get(t)},getNames:function(){return this.names},getDescription:function(t){return this.descriptions.get(t)},getShowInMenu:function(){return this.showInMenu&&this.hasName},setShowInMenu:function(t){this.showInMenu=t},setFloor:function(t){t instanceof Floor&&(this.floor=t)},getFloor:function(){return this.floor},setNode:function(t){t instanceof NavigationNode&&(this.node=t)},getNode:function(){return this.node},addGroup:function(t){this.groups.push(t)},getGroups:function(){return this.groups},getGroupNames:function(){if(this.groupNames[n])return this.groupNames[n];var t={};for(var e in this.groups){var i=this.groups[e].getNames();for(var n in i.getAll())t[n]||(t[n]=[]),t[n].push(i.get(n))}return this.groupNames[n]=t,t},addAdvertisement:function(t){this.advertisements.push(t)},getAdvertisements:function(){return this.advertisements},getTags:function(){return this.tags},setTags:function(t){this.tags=t},setIcon:function(t){this.icon=t},getIcon:function(){return this.icon},setBackground:function(t){this.background=t},getBackground:function(){return this.background},getRoomId:function(){return this.room_id},isAlwaysVisible:function(){return this.alwaysVisible}}),POIAdvertisement=Class.extend({init:function(t,e,i){this.id=e.id,this.image_id=e.image_id,this.text1={},this.text2={},this.link={},this.poi=t;for(var n in i)this.link[n]=e["link_"+n],this.text1[n]=e["text1_"+n]?e["text1_"+n]:e["menu_"+n],this.text2[n]=e["text2_"+n]?e["text2_"+n]:e["3d_"+n]},getID:function(){return this.id},getPOI:function(){return this.poi},getText1:function(t){return t in this.text1?this.text1[t]:!1},getText2:function(t){return t in this.text2?this.text2[t]:!1},getLink:function(t){return t in this.link?this.link[t]:!1}}),POIGroup=Class.extend({init:function(t,e){this.id=t.group_id,this.names=new Translations,this.imageID=t.image_id;for(var i in e)this.names.set(i,t[i]);this.pois=[],this.showInMenu=t.show_main,this.showInTopMenu=t.show_top,this.color=(new Color).fromHex(t.color)},getID:function(){return this.id},getNames:function(){return this.names},getName:function(t){return this.names.get(t)},getNames:function(){return this.names},getShowInMenu:function(){return 0!=this.showInMenu},getShowInTopMenu:function(){return 0!=this.showInTopMenu},getImageID:function(){return this.imageID},addPOI:function(t){this.pois.push(t)},getPOIs:function(){return this.pois},getColor:function(){return this.color}}),WayfinderSearch=Class.extend({init:function(t){this.wayfinder=t,this.searchParams=[],this.limit=0,this.options={maxSearchParams:15,stringSearch:"relative",minimumScore:25,splitKeywords:!0,limit:1/0,scoreLimit:5},this.results={},this.providers={},this.setupProviders()},overrideOptions:function(t){for(var e in t)this.options[e]=t[e]},setupProviders:function(){this.providers.poi=ClassCallback(this,this.POIsProvider)},search:function(t,e,i){var n="poi";if(this.results={},"string"==typeof e&&(n=e),this.overrideOptions(i),"undefined"!=typeof t&&""!==t){t=t.trim().toLowerCase(),this.options.splitKeywords?this.searchParams=t.split(" "):this.searchParams.push(t),this.searchParams.length>this.options.maxSearchParams&&this.searchParams.splice(this.options.maxSearchParams,this.searchParams.length-this.options.maxSearchParams);for(var o=(this.wayfinder.pois,0);o<this.searchParams.length;o++)this.providers[n]&&"function"==typeof this.providers[n]&&this.providers[n](this.searchParams[o],this.wayfinder)}return console.log("this.resuts",this.results),this.order(this.results)},pushResult:function(t,e,i){t>=this.options.minimumScore&&(t=parseFloat(t).toFixed(2),this.results[t]||(this.results[t]={}),this.results[t][e]=i)},POIsProvider:function(t,e){function i(t,e){var i=o.searchString(t.getName(n),e);return t.getDescription(n)&&(i=Math.max(i,o.searchString(t.getDescription(n),e,1))),t.getTags()&&(i=Math.max(i,o.searchString(t.getTags(),e,1))),t.getRoomId()&&(i=Math.max(i,o.searchString(t.getRoomId(),e,1))),i}console.log("POIsProvider",t,e);var n=this.wayfinder.getLanguage(),o=this,a=e.pois;for(var s in a)a[s].getShowInMenu()&&(score=i(a[s],t),this.pushResult(score,a[s].getID(),a[s]))},findWithChar:function(t){var e=[],i=this.wayfinder.getLanguage();e[0]=[];var n=this.sortPOIs(this.wayfinder.pois);for(var o in n)n[o].getShowInMenu()&&n[o].getName(i).charAt(0)==t&&e[0].push(n[o])},searchString:function(t,e,i){if("string"==typeof t&&"string"==typeof e)switch(t=t.toLowerCase().trim(),e=e.toLowerCase().trim(),this.options.stringSearch){case"strict":return this.searchStringStrict(t,e,i);case"relative":return this.searchStringRelatively(t,e,i);default:return this.searchStringStrict(t,e,i)}return 0},searchStringStrict:function(t,e){if(!t||!e)return 0;var i=e.indexOf(t);if(i>-1){i=i/t.length*100;var n=e.length/t.length*100;return(i+n)/2}return 0},searchStringRelatively:function(t,e,i){function n(t,e,i){if(i.length==t.length)return 11*i.length;for(var n=0,o=0,a=0,s=-1,r=0;r<t.length;r++)s==t[r]-1?(o++,n=Math.max(n,o)):(a+=t[r]-s-1,o=1),s=t[r];return 10*n-7*a-3*(e-t.length)-3*(i.length-t.length)}if(!t||!e)return 0;var o=e.split(""),a=t.split(/,\s*|\s/),s=0,r=0,h=[],l=-1;lastFoundIndex=0,i||(i=1);for(var d=0;d<a.length;d++)if(t=a[d],t.length>1){for(;r<t.length;){if(t[r]===o[s]){if(lastFoundIndex=r,h.push(r),s++,s>=o.length)break}else r==t.length-1&&s<o.length&&(r=lastFoundIndex,s++);r++}l=Math.max(l,n(h,o.length,t)),s=0,r=0,h.length=0}return l=Math.round(l*i)},order:function(t){var e=0,i=[],n=t.length-1;console.log("firstScore",n,t.length-1);for(var o=t.length-1;o>=0;o--)if(console.log("searchResult",t[o]),t[o]){i=this.sortPOIs();for(var a in t[o]){var s=t[o][a];if(n/o>this.options.scoreLimit&&e>0)return i;if(i.push(s),e++,this.options.limit>0&&e>this.options.limit)return i;

}}return i}}),Language=Class.extend({init:function(t){this.name=t.name,this.id=t.id,this.nativeName=t["native"],this.textDirection=t.text_direction,this.flagImage=t.flag},getName:function(){return this.name},getID:function(){return this.id},getNativeName:function(){return this.nativeName},getTextDirection:function(){return this.text_direction}}),Translator=Class.extend({init:function(t,e){this.language=t,this.translations=e},setTranslations:function(t){this.translations=t},setLanguage:function(t){this.language=t},getLanguage:function(){return this.language},get:function(t,e){if(this.translations&&t&&this.translations[t]&&this.translations[t][this.language]){var i=this.translations[t][this.language];return e&&(i=this.replaceValues(i,e)),i}return t},translate:function(t){var e=this;t&&(this.language=t),"undefined"!=typeof $&&($("[data-translation-element]").each(function(){e.translateElement($(this),$(this).attr("data-translation-element"))}),$("[data-translation-attributes]").each(function(){var t=$(this).attr("data-translation-attributes").split(","),i="";for(var n in t)i=$(this).attr("data-translation-attribute-"+t[n]),i&&$(this).attr(t[n],e.get(i))}))},setElement:function(t,e){t&&e&&t.attr("data-translation-element",e)},setAttribute:function(t,e,i){if(t&&i&&e){var n=[];t.attr("data-translation-attributes")&&(n=t.attr("data-translation-attributes").split(",")),n.push(e),t.attr("data-translation-attributes",n.join(",")),t.attr("data-translation-attribute-"+e,i)}},translateElement:function(t,e,i){if(t)if(e&&this.exists(e)){var n=this.get(e,i);this.setElement(t,e),t.html(n)}else t.addClass("no-translation")},translateAttribute:function(t,e,i,n){if(t&&e&&i){var o=this.get(i,n);this.setAttribute(t,e,i),t.attr(e,o),this.exists(i)||t.addClass("no-translation")}},replaceValues:function(t,e){if(t&&e){var i=0;for(var n in e)t=t.replace("%"+i++,e[n])}return t},exists:function(t){return this.translations&&t&&this.translations[t]&&this.translations[t][this.language]?!0:!1}}),Translations=Class.extend({init:function(t){this.translations=t?t:{}},set:function(t,e){this.translations[t]=e},get:function(t){return this.translations[t]?this.translations[t]:!1},setAll:function(t){this.translations=t},getAll:function(){return this.translations},setTranslations:function(t,e){if(t&&e){for(var i in this.translations)t.attr("data-lang-"+i,this.translations[i]);t.html(this.translations[e]?this.translations[e]:"no translation"),t.attr("data-translated",!0)}}}),TranslationsMap=Class.extend({init:function(){this.translations={}},add:function(t,e){if(!(e instanceof Translations))throw"Only Translation instances can be added to translations map";this.translations[t]=e},get:function(t){return this.translations[t]?this.translations[t]:new Translations({english:"--missing--"})}}),WFStatistics=Class.extend({init:function(t){this.wayfinder=t,this.session_id=0,this.storageSupport="undefined"!=typeof window&&"localStorage"in window&&null!==window.localStorage,this.storagePrefix="wfstats_",this.device_id=0,this.searchPhrase="",this.checkStorage()},start:function(){var t=this;"undefined"!=typeof screen&&WayfinderAPI.statistics.device(screen.width,screen.height,this.wayfinder.getKiosk(),function(e){e&&(t.device_id=e.data.id,t.store("deviceId",e.data.id),log("Device created",e))})},onSessionStart:function(){var t=this,e=this.wayfinder.languages[this.wayfinder.getLanguage()];e&&e.getID()&&this.wayfinder.getKiosk()&&WayfinderAPI.statistics.startSession(e.getID(),this.wayfinder.getKiosk(),this.wayfinder.options.application,this.wayfinder.getLayout(),this.device_id,function(e){try{e&&(t.session_id=e.data)}catch(i){log("Something went wrong sending startSession")}})},onSessionEnd:function(){var t=this;if(this.session_id){var e=this.wayfinder.languages[this.wayfinder.getLanguage()];WayfinderAPI.statistics.endSession(this.session_id,e.getID(),function(){t.session_id=0,log("Session ended!")})}},onClick:function(t,e){WayfinderAPI.statistics.click(t,this.session_id,e)},onLanguageChange:function(){},onSearch:function(t,e){WayfinderAPI.statistics.search(t,this.session_id,e)},checkStorage:function(){this.storageSupport&&(this.deviceId=localStorage.getItem(this.storagePrefix+"deviceId"))},getTime:function(){},store:function(t,e){this.storageSupport&&(localStorage[this.storagePrefix+t]=JSON.stringify(e))},isOnline:function(){}}),Layers={Default:1,POI:2,MaskAll:4294967295},Pathfinder3D=function(t,e){function i(){for(var t=1/0,e=0,i=0;i<g.length;i++)u[g[i]]<t&&(t=u[g[i]],e=i);return e}function n(t){return t in p}function o(t){for(var e=0;e<g.length&&g[e]!=t;e++);for(var i=e-1;i>0&&u[g[e]]<u[g[i]];i--){var n=g[i];g[i]=g[e],g[e]=n,e=i}}function a(t,e){var i=h[t].position,n=h[e].position;return vec3.distance(i,n)}function s(t){return 180*t/Math.PI}function r(t,e,i){var n=vec2.subtract(vec2.create(),vec2.fromValues(t[0],t[2]),vec2.fromValues(e[0],e[2]));vec2.normalize(n,n);var o=vec2.subtract(vec2.create(),vec2.fromValues(e[0],e[2]),vec2.fromValues(i[0],i[2]));vec2.normalize(o,o);var a=Math.round(s(Math.atan2(n[0]*o[1]-n[1]*o[0],n[0]*o[0]+n[1]*o[1])));return 0>a&&(a=360+a),a}var h=t,l=e,d=null,c=null,u={},f={},g=[],p={};this.find=function(t,e){var s;d=t,c=e,u={},f={},g=[],p={};for(s in h)u[s]=1/0,f[s]=null,g.push(s);for(u[d]=0;g.length>0;){var r=i(),m=g[r];if(u[m]==1/0)break;if(g.splice(r,1),p[m]=!0,m==c){var y=[];for(m=c;null!==f[m];)y.push(m),m=f[m];return y.push(d),y.reverse(),y}for(s=0;s<l[m].length;s++){var v=l[m][s];if(!n(v)){var P=u[m]+a(m,v)+parseFloat(h[v].weight);P<u[v]&&(v in l||v==c)&&(u[v]=P,f[v]=m,o(v))}}}return[]},this.pathLength=function(t){var e=-1,i=null;for(var n in t)i&&n?(e+=a(i,t[n]),i=t[n]):i=t[n];return Math.round(e)},this.pathToText=function(t){var e,i=[],n=null,o=null,s=0;if(t.length>3){if(n={},h[t[0]]&&h[t[0]].rotation){var l=h[t[0]].rotation[1];o=vec2.subtract(vec2.create(),vec2.fromValues(h[t[0]].position[0],h[t[0]].position[2]),vec2.fromValues(h[t[1]].position[0],h[t[1]].position[2])),o=vec2.normalize(o,o),s=Math.round(Math.acos(vec2.dot(o,vec2.fromValues(0,1)))*(180/Math.PI)),s+=l,0>s&&(s=360+s),i.push({angle:s,distance:0}),s=0}for(var d=0;d<t.length;d++)d<t.length-1&&(n={},e=h[t[d]],o=h[t[d+1]],n.distance=Math.round(a(t[d],t[d+1])),d<t.length-2?(s=r(h[t[d]].position,h[t[d+1]].position,h[t[d+2]].position),n.angle=s):n.angle=0,h[t[d]].floor&&h[t[d+1]].floor&&h[t[d]].floor.index!=h[t[d+1]].floor.index&&(n.go_to_floor=h[t[d+1]].floor.id),h[t[d]].type&&(n.type=h[t[d]].type),n.aNode=e,n.bNode=o,i.push(n))}return i}},Floor3D=Floor.extend({init:function(t,e){this._super(t,e),this.node3D=!1,this.mapMeshPathToID={},this.mapIDToMeshPath={}},setMeshNames:function(t){for(var e in t)this.mapMeshPathToID[t[e]]=parseInt(e),this.mapIDToMeshPath[parseInt(e)]=t[e]},getMeshIDByPath:function(t){return t in this.mapMeshPathToID?this.mapMeshPathToID[t]:0},getMeshPathByID:function(t){return t in this.mapIDToMeshPath?this.mapIDToMeshPath[t]:!1},showYAH:function(){if(this.node3D){var t=this.node3D.find("YAHLocation/YAH");t&&t.onEachChild(function(t){var e=t.getComponent(RendererComponent);e&&e.enable();var i=t.getComponent(Billboard);i&&i.enable()})}},hideYAH:function(){if(this.node3D){var t=this.node3D.find("YAHLocation/YAH");t&&t.onEachChild(function(t){var e=t.getComponent(RendererComponent);e&&e.disable();var i=t.getComponent(Billboard);i&&i.disable()})}}}),POI3D=POI.extend({init:function(t,e){this._super(t,e),this.object=!1,this.visible=!1,this.meshNode=!1,this.submesh=!1,this.canvasBoard=!1},show:function(){if(this.object){{this.getName("en")}this.visible=!0,this.object.onEachChild(function(t){var e=t.getComponent(RendererComponent);e&&e.enable();var i=t.getComponent(Billboard);i&&i.enable();var n=t.getComponent(DistanceScalingComponent);n&&n.enable()})}},hide:function(){this.object&&(this.visible=!1,this.object.onEachChild(function(t){var e=t.getComponent(RendererComponent);e&&e.disable();var i=t.getComponent(Billboard);i&&i.disable();var n=t.getComponent(DistanceScalingComponent);n&&n.disable()}))},highlight:function(){this.object&&this.object.onEachChildComponent(function(t){t instanceof POIComponent&&t.startHighlight()})},stopHighlight:function(){this.object&&this.object.onEachChildComponent(function(t){t instanceof POIComponent&&t.stopHighlight()})},dehighlight:function(){this.object&&this.object.onEachChildComponent(function(t){t instanceof POIComponent&&t.dehighlight()})},startAnimating:function(){this.object&&this.object.onEachChild(function(t){var e=t.getComponent(AnimationComponent);e&&e.startAnimating()})},setAnimation:function(t,e,i){this.object&&this.object.onEachChild(function(n){var o=n.getComponent(AnimationComponent);o&&(t&&o.setLowestPosition(t),e&&o.setHighestPosition(e),i&&o.setAnimationSpeed(i))})},stopAnimating:function(){this.object&&this.object.onEachChild(function(t){var e=t.getComponent(AnimationComponent);e&&e.finishAnimating()})},setNode:function(t){this._super(t),this.object&&this.node&&mat4.fromTranslation(this.object.transform.relative,this.node.position)},createGeometry:function(t,e){var i=e.settings.getBoolean("poi.3d.billboard",!1,this),n=e.settings.getBoolean("poi.3d.billboard-clickable",!0,this),o=e.settings.getBoolean("poi.3d.height-from-floor-enabled",!0,this),o=e.settings.getBoolean("poi.3d.height-from-floor-enabled",!0,this),a=e.settings.getInt("poi.text.wrap",-1,this),s=e.settings.getBoolean("poi.3d.enable-canvas-board",!1,this);0==this.mesh_id&&(i=!1);var r={billboardClickable:n,heightFromFloor:o,disableBillboard:i,wordWrap:a};s?this.createCanvasBoard(t,e,r):this.image_id>0?this.createIconGeometry(t,e,r):this.createNameGeometry(t,e,r)},createIconGeometry:function(t,e,i){var n=new TextureDescriptor(this.image_id);n.loadAsImage=!0;var o=new Material(t.assetsManager.addShaderSource("Transparent"),{diffuse:new UniformColor(new Color)},[new Sampler("diffuse0",t.assetsManager.texturesManager.addDescriptor(n))]);o.name="POI_icon_"+this.getID(),o.shader.requirements.transparent=!0;var a=Primitives.plane(1,1,o);a.name="POI";var s=a.getComponent(MeshRendererComponent);s.disable(),s.castShadows=!1,s.lightContribution=0,i.billboardClickable&&a.addComponent(new MeshCollider),i.disableBillboard||a.addComponent(new Billboard(t.scene.camera,!0)),a.addComponent(new DistanceScalingComponent(t.scene.camera)),a.addComponent(new AnimationComponent);var r=new POIComponent(this,e.getKioskNode());r.heightFromFloor=i.heightFromFloor,a.addComponent(r),a.layer=Layers.POI,this.object=new Node("POILocation"),mat4.fromTranslation(this.object.transform.relative,this.node.position),this.object.addNode(a)},createNameGeometry:function(t,e,i){var n=Primitives.text(this.getName(e.translator.getLanguage()),i.wordWrap);i.billboardClickable&&n.addComponent(new MeshCollider);var o=new POIComponent(this,e.getKioskNode());o.heightFromFloor=i.heightFromFloor,n.addComponent(o),n.addComponent(new DistanceScalingComponent(t.scene.camera)),i.disableBillboard||n.addComponent(new Billboard(t.scene.camera,!0)),n.addComponent(new AnimationComponent),n.getComponent(TextRendererComponent).castShadows=!1,n.getComponent(TextRendererComponent).lightContribution=0,n.getComponent(TextRendererComponent).disable(),n.layer=Layers.POI;var a=n.getComponent(TextComponent);a.family="Tahoma, Geneva, sans-serif",a.color.set(1,1,1,1),a.outlineColor.set(0,0,0,1),this.object=new Node("POILocation"),mat4.fromTranslation(this.object.transform.relative,this.node.position),this.object.addNode(n)},createCanvasBoard:function(t,e,i){this.canvasBoard=Primitives.canvasBoard(256,256),this.canvasBoard.name="POI",i.billboardClickable&&this.canvasBoard.addComponent(new MeshCollider);var n=new POIComponent(this,e.getKioskNode());n.heightFromFloor=i.heightFromFloor,this.canvasBoard.addComponent(n),this.canvasBoard.addComponent(new DistanceScalingComponent(t.scene.camera)),i.disableBillboard||this.canvasBoard.addComponent(new Billboard(t.scene.camera,!0)),this.canvasBoard.addComponent(new AnimationComponent),this.canvasBoard.getComponent(CanvasBoardRendererComponent).castShadows=!1,this.canvasBoard.getComponent(CanvasBoardRendererComponent).lightContribution=0,this.canvasBoard.getComponent(CanvasBoardRendererComponent).disable(),this.canvasBoard.layer=Layers.POI,this.object=new Node("POILocation"),mat4.fromTranslation(this.object.transform.relative,this.node.position),this.object.addNode(this.canvasBoard)},getCanvasBoard:function(){return this.canvasBoard?this.canvasBoard.getComponent(CanvasBoardComponent):!1},createPOISignOnMeshGeometry:function(t,e){var i=Primitives.text(this.getName(e.translator.getLanguage())),n=new Node("DebugLine"),o=n.addComponent(new LineRendererComponent(new Color(1,0,1,1)));o.overlay=!0,i.addComponent(new POIComponent(this,e.getKioskNode(),o)),i.getComponent(TextRendererComponent).castShadows=!1,i.getComponent(TextRendererComponent).lightContribution=0,i.getComponent(TextRendererComponent).disable();var a=i.getComponent(TextComponent);a.family="Tahoma, Geneva, sans-serif",a.color.set(1,1,1,1),a.outlineColor.set(0,0,0,1),this.object=new Node("POILocation"),mat4.fromTranslation(this.object.transform.relative,this.node.position),this.object.addNode(i),mat4.fromTranslation(n.transform.relative,vec3.fromValues(-this.node.position[0],0,-this.node.position[2])),this.object.addNode(n)},linkMesh:function(){if(0!==this.mesh_id&&this.object&&this.floor&&this.floor.node3D){var t=this.object.find("/POIController").getComponent(POIController),e=t.getMeshInfoByID(this.mesh_id);if(e!==!1){var i=e.path.split("/");if(!(i.length<2)){var n=parseInt(i.pop().substring(5)),o=i.join("/");if(!(0>n)&&(this.meshNode=e.floor.node3D.find(o),this.meshNode)){var a=this.meshNode.getComponent(MeshComponent);a&&(n<a.mesh.submeshes.length&&(this.submesh=a.mesh.submeshes[n]),this.setDistanceScalingByMesh&&this.object.onEachChildComponent(function(t){t instanceof DistanceScalingComponent&&(t.maxScale=Math.min(a.mesh.boundingSphere.radius/2,t.maxScale))}))}}}}},applySettings:function(t){if(this.object){var e=this;this.object.onEachChildComponent(function(i){if(i instanceof POIComponent){if(i.offsetY=t.getFloat("poi.3d.offset",0,e),i.width=t.getFloat("poi.width",1,e),i.height=t.getFloat("poi.height",1,e),i.highlightColors[0]=t.getColor("poi.highlight.color1","#ff0000ff",e).toVector(),i.highlightColors[1]=t.getColor("poi.highlight.color2","#0000ffff",e).toVector(),i.dehighlightColor=t.getColor("poi.dehighlight.color","#888888ff",e).toVector(),i.highlightDuration=t.getFloat("poi.highlight.duration",5,e),i.highlightSpeed=t.getFloat("poi.highlight.speed",1,e),i.textSize=t.getFloat("poi.text.size",1,e),i.textColor=t.getColor("poi.text.color","#FFFFFF",e),i.outline=t.getBoolean("poi.text.outline",!1,e),i.outlineColor=t.getColor("poi.text.outline-color","#000000",e),i.outlineWidth=t.getInt("poi.text.outline-width",5,e),i.backgroundColor=t.getColor("poi.text.background-color","#00000000",e),i.disableBillboard=t.getBoolean("poi.3d.billboard",!1,e),i.billboardClickable=t.getBoolean("poi.3d.billboard-clickable",e),t.getBoolean("poi.3d.meshgroupcolor",!1,e)&&e.groups.length>0&&e.groups[0]){var n=e.groups[0];i.groupColor=n.getColor().toVector()}}else i instanceof DistanceScalingComponent?(i.doingIt=t.getBoolean("poi.distancescaling.enabled",!1,e),i.maxScale=t.getFloat("poi.distancescaling.maxscale",15,e),t.getBoolean("poi.distancescaling.mesh",!1,e)&&(e.setDistanceScalingByMesh=!0)):i instanceof AnimationComponent&&(t.getBoolean("path.animation.poi",!1,e)||i.disable())})}}}),NavigationNode3D=NavigationNode.extend({init:function(t){this._super(t),this.node3D=!1}}),WayfinderFactory3D=WayfinderFactory.extend({createFloor:function(t,e){return new Floor3D(t,e)},createNode:function(t){return new NavigationNode3D(t)},createPOI:function(t,e){return new POI3D(t,e)}}),Wayfinder3D=Wayfinder.extend({init:function(t){t&&t instanceof WayfinderOptions||(t=new WayfinderOptions3D),this._super(t,new WayfinderFactory3D(this)),this.engine=!1,this.logic=!1,this.dataLoaded=!1,this.engineLoaded=!1,this.orbitController=!1,this.poiController=!1,this.pathComponent=!1,this.materials=!1,this.floorMeshes={},this.screensaving=!1,this.screensaver=!1},startLoading:function(){this._super(),Logistics.getJSON(WayfinderAPI.getURL("materials","get",[]),null,ClassCallback(this,this.onMaterialsLoaded),{stage:"settings"})},cbOnWebGLContextFail:function(){return!1},onMaterialsLoaded:function(t){t&&t.data&&(this.materials=t.data)},showFloor:function(t,e,i){this._super(t,e),this.logic&&this.logic.showFloor(t,e,i)},showPath:function(t,e,i,n){if(!(t instanceof NavigationNode))return[];var o=this.options.kiosk,a=t.id;if(this.logic)try{var s=this.logic.showPath(o,a,e,i,n);return s}catch(r){log("Warning: Could not show path from "+o+" to "+a)}return[]},showKiosk:function(t){this.setDefaultView(t)},setZoom:function(t){this.orbitController&&this.orbitController.setZoom(1-t)},zoomIn:function(){this.orbitController&&this.orbitController.zoomIn()},zoomOut:function(){this.orbitController&&this.orbitController.zoomOut()},setDefaultView:function(){this.logic&&this.logic.setDefaultView()},pathToText:function(t){var e=new Pathfinder3D(this.nodes,this.edges),i=e.pathToText(t);return console.log("path",i),this.textPathSimplification(i)},onPOIsLoaded:function(t){this._super(t);var e=this.building.getFloors(),i={};for(var n in e)i["floor-meshes-"+e[n].id]={url:WayfinderAPI.getURL("models","meshes",[e[n].model_id]),type:"json"};Logistics.getMultiple(i,ClassCallback(this,this.onMeshesLoaded),{stage:"models"})},onMeshesLoaded:function(t){this.floorMeshes=t,this.setupEngine()},setupEngine:function(){var t="sorted";this.settings.getBoolean("camera.correct-transparency.enabled",!1)&&(t="blended",this.settings.getBoolean("camera.correct-transparency.stochastic-enabled",!1)&&(t="stochastic"));var e="forward";this.settings.getBoolean("camera.deferred-renderer.enabled",!1)&&(e="auto"),this.engine=new Engine(this.options.map,{requestedFPS:30,renderer:e,antialias:this.settings.getBoolean("camera.antialiasing.enabled",!1),ssao:this.settings.getBoolean("camera.ssao.enabled",!1),ssaoGDisplace:this.settings.getFloat("camera.ssao.gdisplace",.4),ssaoRadius:this.settings.getFloat("camera.ssao.radius",2),ssaoLuminanceInfluence:this.settings.getFloat("camera.ssao.luminance-influence",.7),ssaoBrightness:this.settings.getFloat("camera.ssao.brightness",1),transparencyMode:t,softShadows:this.settings.getBoolean("camera.deferred-renderer.soft-shadows",!1),assetsPath:this.options.assetsLocation,contextErrorCallback:ClassCallback(this,this.cbOnWebGLContextFail)});var i=document.getElementById(this.options.map);i.className+=" no-select",i.addEventListener("selectstart",function(){},!1),window.addEventListener("resize",ClassCallback(this,this.resize)),this.resize();var n=this;this.engine.assetsManager.shadersManager.shadersPath=this.options.assetsLocation,this.engine.assetsManager.modelsManager.createParser=function(t,e,i,n,o){var a=new ThreadedDataParser(t,e,i,n,o);return a.flipX=!0,a},this.engine.assetsManager.texturesManager.sourceCallback=function(t){return t},this.engine.assetsManager.texturesManager.descriptorCallback=function(t){return t.loadAsImage?(t.source=WayfinderAPI.images.get.url(t.source),t.parentDescriptor=!1,t):(t.parentDescriptor=!1,t.source=n.options.textureLOD===!1?WayfinderAPI.textures.texture.url(t.source):WayfinderAPI.textures.mipmap.url(n.options.textureLOD,t.source),t)};var o=this.building.getFloors();for(var a in o){var s=o[a],r=new Node("Level-"+s.index);if(r.addComponent(new FloorComponent(s)),r.addComponent(new FloorFlightComponent),s.node3D=r,!this.options.disableModelLoading){var h=new ModelDescriptor(WayfinderAPI.models.json.url(s.model_id),"json");r.addNode(this.engine.assetsManager.modelsManager.addDescriptor(h))}this.engine.scene.root.addNode(r)}this.engine.assetsManager.load(ClassCallback(this,this.onAssetsLoaded),ClassCallback(this,this.onAssetsProgress))},onAssetsProgress:function(){},onAssetsLoaded:function(){var t=this;if(!this.dataLoaded){this.dataLoaded=!0,this.onDataLoaded(),this.logic=new WayfinderLogic3D(this);var e=new WayfinderSetup3D(this);this.engine.sceneStarted=function(){e.setup(),"function"==typeof t.cbOnMapReady&&t.cbOnMapReady()},this.options.disableRendering||this.engine.run()}},onProgress:function(t){"function"==typeof this.cbOnProgress&&this.cbOnProgress(t)},resize:function(){if(this._super(),this.engine.context instanceof RenderingContext){{var t=this.engine.context.gl;t.canvas.clientWidth,Math.max(1,t.canvas.clientHeight)}this.engine.scene.cameraComponent.setAspectRatio(t.drawingBufferWidth/t.drawingBufferHeight),this.engine.scene.camera.target.setSize(t.drawingBufferWidth,t.drawingBufferHeight),this.orbitController&&this.onZoomChange(this.orbitController.getZoom())}},getNearestPOI:function(t,e){return this.logic?this.logic.getNearestPOI(t,e):null},showScreensaver:function(){if((!this.pathComponent||!this.pathComponent.path||this.pathComponent.finished)&&(this.clearHighlights(),this.showKiosk(),this.settings.getBoolean("kiosk.screensaver.enabled",!1)&&this.screensaver)){this.screensaving=!0;var t=[];for(var e in this.pois)this.pois[e].node_id in this.nodes&&this.pois[e].node_id!=this.options.kiosk&&this.pois[e].node_id!=this.screensaver.destNodeID&&t.push(this.pois[e].node_id);var i=t[Math.floor(Math.random()*t.length)];for(var e in this.nodes[i].pois)this.nodes[i].pois[e].show();var n=this;this.screensaver.setDestination(this.nodes[i],i,function(){if(n.nodes[i].pois)for(var t in n.nodes[i].pois)n.nodes[i].pois[t].hide()});for(var e in this.nodes[i].pois)this.nodes[i].pois[e].show()}},restoreDefaultState:function(){this._super(),this.pathComponent&&this.pathComponent.clearPath()},hideScreensaver:function(){this.screensaving=!1,this.screensaver&&this.screensaver.clearDestination(),this.restoreDefaultState()},setHighlights:function(t){this.clearHighlights(),this.poiController&&t&&this.poiController.setHighlights(t)},clearHighlights:function(){this.poiController&&this.poiController.clearHighlights()},setDisplaying:function(t){this.clearDisplaying(),this.poiController&&t&&this.poiController.setDisplaying(t)},clearDisplaying:function(){this.poiController&&this.poiController.clearDisplaying()},onSetLanguage:function(t){for(var e in this.pois){var i=this.pois[e];if(i.object&&!(i.object.subnodes.length<1)){var n=i.object.subnodes[0].getComponent(TextComponent);if(n){var o=i.getName(t);o&&n.setText(o)}}}},clearPath:function(){this.pathComponent&&this.pathComponent.clearPath()},zoomOnPathSegment:function(t,e){this.pathComponent.zoomOnPathSegment(t,e)}}),Wayfinder3DEx=Wayfinder.extend({init:function(t){t&&t instanceof WayfinderOptions||(t=new WayfinderOptions3D),this._super(t,new WayfinderFactory3D(this)),this.engine=!1,this.logic=!1,this.dataLoaded=!1,this.engineLoaded=!1,this.orbitController=!1,this.poiController=!1,this.pathComponent=!1,this.materials=!1,this.floorMeshes={},this.screensaving=!1,this.screensaver=!1},startLoading:function(){{var t=this;new WayfinderLoading3D(this,function(){t.setupEngine()})}},onSettings:function(){this.building=this.factory.createBuilding(this.settings.data),this.options.language=this.settings.get("language.default",this.options.language),this.setLanguage(this.options.language),this.options.kiosk===!1&&this.setKiosk(this.settings.getInt("kiosk.default",0))},showFloor:function(t,e,i){this._super(t,e),this.logic&&this.logic.showFloor(t,e,i)},showPath:function(t,e,i,n){if(!(t instanceof NavigationNode))return[];var o=this.options.kiosk,a=t.id;if(this.logic)try{var s=this.logic.showPath(o,a,e,i,n);return s}catch(r){log("Warning: Could not show path from "+o+" to "+a)}return[]},showKiosk:function(t){this.setDefaultView(t)},setZoom:function(t){this.orbitController&&this.orbitController.setZoom(1-t)},zoomIn:function(){this.orbitController&&this.orbitController.zoomIn()},zoomOut:function(){this.orbitController&&this.orbitController.zoomOut()},setDefaultView:function(){this.logic&&this.logic.setDefaultView()},pathToText:function(t){var e=new Pathfinder3D(this.nodes,this.edges),i=e.pathToText(t);return this.textPathSimplification(i)},setupEngine:function(){var t=$("#"+this.options.map),e="sorted";this.settings.getBoolean("camera.correct-transparency.enabled",!1)&&(e="blended",this.settings.getBoolean("camera.correct-transparency.stochastic-enabled",!1)&&(e="stochastic"));var i="forward";this.settings.getBoolean("camera.deferred-renderer.enabled",!1)&&(i="auto"),this.engine=new Engine(this.options.map,{requestedFPS:30,renderer:i,antialias:this.settings.getBoolean("camera.antialiasing.enabled",!1),ssao:this.settings.getBoolean("camera.ssao.enabled",!1),ssaoGDisplace:this.settings.getFloat("camera.ssao.gdisplace",.4),ssaoRadius:this.settings.getFloat("camera.ssao.radius",2),ssaoLuminanceInfluence:this.settings.getFloat("camera.ssao.luminance-influence",.7),ssaoBrightness:this.settings.getFloat("camera.ssao.brightness",1),transparencyMode:e,softShadows:this.settings.getBoolean("camera.deferred-renderer.soft-shadows",!1),assetsPath:this.options.assetsLocation}),t.addClass("no-select").on("selectstart",!1),$(window).resize(ClassCallback(this,this.resize)),this.resize();var n=this;this.engine.assetsManager.shadersManager.shadersPath=this.options.assetsLocation,this.engine.assetsManager.modelsManager.createParser=function(t,e,i,n,o){var a=new ThreadedDataParser(t,e,i,n,o);return a.flipX=!0,a},this.engine.assetsManager.texturesManager.sourceCallback=function(t){return t},this.engine.assetsManager.texturesManager.descriptorCallback=function(t){return t.loadAsImage?(t.source=WayfinderAPI.images.get.url(t.source),t.parentDescriptor=!1,t):(t.parentDescriptor=!1,t.source=n.options.textureLOD===!1?WayfinderAPI.textures.texture.url(t.source):WayfinderAPI.textures.mipmap.url(n.options.textureLOD,t.source),t)};var o=this.building.getFloors();for(var a in o){var s=o[a],r=new Node("Level-"+s.index);if(r.addComponent(new FloorComponent(s)),r.addComponent(new FloorFlightComponent),s.node3D=r,!this.options.disableModelLoading){var h=new ModelDescriptor(WayfinderAPI.models.json.url(s.model_id),"json");r.addNode(this.engine.assetsManager.modelsManager.addDescriptor(h))}this.engine.scene.root.addNode(r)}this.engine.assetsManager.modelsManager.load(ClassCallback(this,this.onAssetsLoaded),function(t){"function"==typeof n.cbOnProgress&&n.cbOnProgress(t)})},placeDynamicModels:function(t,e){var i=this,n=new Node("Models-all"),o=function(){var o=t[0];if(o.node3D&&o.instances){var a=o.instances[0];if(a.node3D=o.node3D.instantiate(),a.node3D.transform.setPosition(a.position),e.node.node3D=a.node3D,a.floor){var s=i.engine.scene.root.findChildWithName("Level-"+a.floor);s?(e.node.position=a.position,e.setNode(e.node),s.addNode(e.node.node3D)):n.addNode(a.node3D)}else n.addNode(a.node3D)}i.engine.scene.root.addNode(n)},a=t[0],s=new ModelDescriptor(WayfinderAPI.models.json.url(a.id),"json");a.node3D=this.engine.assetsManager.modelsManager.addDescriptor(s),this.engine.assetsManager.modelsManager.load(o)},onAssetsLoaded:function(){var t=this;this.onDataLoaded();var e=this.settings.getInt("template.client.js",0);this.texts[e]&&window.eval.call(window,this.texts[e]),this.logic=new WayfinderLogic3D(this);var i=new WayfinderSetup3D(this);this.engine.sceneStarted=function(){i.setup(),"function"==typeof t.cbOnMapReady&&t.cbOnMapReady()},this.options.disableRendering||this.engine.run()},onProgress:function(){},resize:function(){if(this._super(),this.engine.context instanceof RenderingContext){{var t=this.engine.context.gl;t.canvas.clientWidth,Math.max(1,t.canvas.clientHeight)}this.engine.scene.cameraComponent.setAspectRatio(t.drawingBufferWidth/t.drawingBufferHeight),this.engine.scene.camera.target.setSize(t.drawingBufferWidth,t.drawingBufferHeight),this.orbitController&&this.onZoomChange(this.orbitController.getZoom())}},getNearestPOI:function(t,e){return this.logic?this.logic.getNearestPOI(t,e):null},showScreensaver:function(){if((!this.pathComponent||!this.pathComponent.path||this.pathComponent.finished)&&(this.clearHighlights(),this.showKiosk(),this.settings.getBoolean("kiosk.screensaver.enabled",!1)&&this.screensaver)){this.screensaving=!0;var t=[];for(var e in this.pois)this.pois[e].node_id in this.nodes&&this.pois[e].node_id!=this.options.kiosk&&this.pois[e].node_id!=this.screensaver.destNodeID&&t.push(this.pois[e].node_id);var i=t[Math.floor(Math.random()*t.length)];for(var e in this.nodes[i].pois)this.nodes[i].pois[e].show();var n=this;this.screensaver.setDestination(this.nodes[i],i,function(){if(n.nodes[i].pois)for(var t in n.nodes[i].pois)n.nodes[i].pois[t].hide()});for(var e in this.nodes[i].pois)this.nodes[i].pois[e].show()}},restoreDefaultState:function(){this._super(),this.pathComponent&&this.pathComponent.clearPath()},hideScreensaver:function(){this.screensaving=!1,this.screensaver&&this.screensaver.clearDestination(),this.restoreDefaultState()},setHighlights:function(t){this.clearHighlights(),this.poiController&&t&&this.poiController.setHighlights(t)},clearHighlights:function(){this.poiController&&this.poiController.clearHighlights()},setDisplaying:function(t){this.clearDisplaying(),this.poiController&&t&&this.poiController.setDisplaying(t)},clearDisplaying:function(){this.poiController&&this.poiController.clearDisplaying()},onSetLanguage:function(t){for(var e in this.pois){var i=this.pois[e];if(i.object&&!(i.object.subnodes.length<1)){var n=i.object.subnodes[0].getComponent(TextComponent);if(n){var o=i.getName(t);o&&n.setText(o)}}}},clearPath:function(){this.pathComponent&&this.pathComponent.clearPath()},zoomOnPathSegment:function(t,e){this.pathComponent.zoomOnPathSegment(t,e)}}),WayfinderLoading3D=Class.extend({init:function(t,e){this.wayfinder=t,this.callback=e,Logistics.getJSON(WayfinderAPI["3d"].scene.url(),null,ClassCallback(this,this.onSceneData),{stage:"settings"})},onSceneData:function(t){var e=t.data;this.wayfinder.settings.data=e.settings,this.wayfinder.poisettings.data=e.poisettings,this.wayfinder.texts=e.texts,this.wayfinder.onSettings(),e.guitranslations&&this.wayfinder.translator.setTranslations(e.guitranslations),this.createLanguages(e.languages),this.wayfinder.factory.createFloors(e.levels),this.createLocations(e);for(var i in e.meshes){var n={},o=e.meshes[i];for(var a in o)n[a]=o[a].name;this.wayfinder.floorMeshes["floor-meshes-"+i]={data:n}}this.wayfinder.materials=e.materials,this.callback&&this.callback()},createLanguages:function(t){for(var e in t)this.wayfinder.languages[e]=new Language(t[e]),e.toLowerCase()==this.wayfinder.options.language.toLowerCase()&&(this.wayfinder.translator.language=e);this.wayfinder.translator.translate()},createLocations:function(t){this.wayfinder.factory.createNodes(t.navigation.nodes),this.wayfinder.factory.createEdges(t.navigation.edges),this.wayfinder.factory.createPOIs(t.locations.all),this.wayfinder.factory.addPOIsToFloor(t.locations.byfloor),this.wayfinder.factory.createGroups(t.locations.groups,t.locations.bygroup),this.wayfinder.factory.createTags(t.locations.tags),this.wayfinder.factory.filterPOIs(this.wayfinder.options.filterPOIs.trim().split(",")),this.wayfinder.advertisements=t.a,Logistics.getJSON(WayfinderAPI.navigation.allAttributes.url(),null,ClassCallback(this.wayfinder.factory,this.wayfinder.factory.createAttributes),{stage:"settings"})}}),WayfinderOptions3D=WayfinderOptions.extend({init:function(){this._super(),this.application="3d",this.assetsLocation="/shared/",this.pathDisplayInstructions=!0,this.pathZoomPadding=100,this.pathColor="rgba(255,0,0,0.8)",this.pathPauseTime=2e3,this.pathSpotRadius=3,this.pathStride=30,this.pathSpeed=60,this.zoomPadding=1.05,this.poiColor="rgba(100,200,0,0.9)",this.poiRadius=9,this.textureLOD=0,this.debugTransparency=!1,this.disableModelLoading=!1,this.disableCollisionTrees=!1,this.disableRendering=!1}}),WayfinderSetup3D=Class.extend({init:function(t){this.wayfinder=t},setup:function(){var t=this.wayfinder.engine.scene;this.overrideBuildingMaterials(),this.setupPathComponent(t),this.setupScreensaverComponent(t),this.setupCamera(t),this.setupOrbitController(t),
this.setupLights(t),this.setupPOIs(t),this.setupYAH(t),this.setupSkybox(t),t.cameraComponent.fitNodeToView(t.root),this.wayfinder.options.debugTransparency&&(t.cameraComponent.camera.renderStage=new DebugRenderStage(new TargetScreen,this.wayfinder.engine)),this.wayfinder.showKiosk()},setupCamera:function(t){t.camera.backgroundColor=this.wayfinder.settings.getColor("scene.background-color","#FFFFFF00"),t.cameraComponent instanceof PerspectiveCamera&&t.cameraComponent.setClipPlanes(this.wayfinder.settings.getFloat("camera.plane.near",.1),this.wayfinder.settings.getFloat("camera.plane.far",1e3))},setupPathComponent:function(t){var e=new Node;this.wayfinder.pathComponent=e.addComponent(new PathComponent(this.wayfinder.nodes,this.wayfinder)),t.root.addNode(e)},setupScreensaverComponent:function(t){if(this.wayfinder.settings.getBoolean("kiosk.screensaver.enabled",!1)){var e=new Node;this.wayfinder.screensaver=e.addComponent(new ScreensaverComponent(this.wayfinder)),t.root.addNode(e)}},setupOrbitController:function(t){var e=this.wayfinder.settings,i=t.root.addNode(new Node("CameraTarget")),n=t.cameraNode.addComponent(new WayfinderOrbitController(this.wayfinder));n.target.value=i.transform,n.distance=50,n.distanceSteps=64,n.minimumDistance=e.getFloat("camera.distance.min",10),n.maximumDistance=e.getFloat("camera.distance.max",100);var o=t.root.getBoundingBox();o&&(n.minimumPan[0]=o.min[0],n.minimumPan[1]=o.min[1],n.minimumPan[2]=o.min[2],n.maximumPan[0]=o.max[0],n.maximumPan[1]=o.max[1],n.maximumPan[2]=o.max[2]),n.minimumPitch=-Math.PI/2.2,n.maximumPitch=-.1,e.getBoolean("mouse.invert-buttons",!1)&&(n.panButton=0,n.rotateButton=2);var a=e.getBoolean("mouse.enable-rotation",!0);n.enableRotation(a);var s=e.getBoolean("mouse.enable-touch-rotation",!1);n.enableTouchRotation(s),this.wayfinder.orbitController=n;var r=this;n.cbOnChange=function(t,e){r.wayfinder.cbOnTouch(t,e)}},setupLights:function(t){function e(e){if(e&&e.data){var i=!0,n=!0;for(var a in e.data){var s=e.data[a],r=s.color.split(" "),h=new Color(parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2])),l=s.rotation.split(" "),d=quat.fromValues(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2]),parseFloat(l[3])),c=vec3.transformQuat(vec3.create(),vec3.fromValues(0,-1,0),d),u=s.position.split(" "),f=vec3.fromValues(parseFloat(u[0]),parseFloat(u[1]),parseFloat(u[2])),g=parseFloat(s.intensity);switch(s.type){case"point":var p=new Node("Omni");p.addComponent(new OmniLight(parseFloat(s.radius),h)).intensity=g,p.transform.setPosition(f),t.lightNode.addNode(p);break;case"ambient":if(n)o.color=h,n=!1;else{var m=new Node("Ambient");m.addComponent(new AmbientLight(h)).intensity=g,t.lightNode.addNode(m)}break;case"directional":if(i)t.light.intensity=g,t.light.color=h,t.light.setLightDirection(c),i=!1;else{var y=new Node("Directional");y.addComponent(new DirectionalLight(c,h)).intensity=g,t.lightNode.addNode(y)}}}}}var i=this.wayfinder.settings;t.light.intensity=i.getFloat("lights.directional.intensity",1),t.light.shadowCasting=i.getBoolean("lights.directional.shadows",!1),t.light.color=i.getColor("lights.directional.color",new Color(1,1,.98)),t.light.setLightDirection(vec3.fromValues(i.getFloat("lights.directional.direction-x",1),i.getFloat("lights.directional.direction-y",1),i.getFloat("lights.directional.direction-z",1)));var n=i.getColor("lights.ambient.color",new Color(.5,.5,.5)),o=t.lightNode.addComponent(new AmbientLight(n));Logistics.getJSON(WayfinderAPI.getURL("lights","get",[]),null,e,{stage:"settings"})},setupPOIs:function(t){var e=new Node("POIController"),i=e.addComponent(new POIController(this.wayfinder));t.root.addNode(e);var n=this.wayfinder.building.getFloors();for(var o in n){var a=n[o],s=this.wayfinder.floorMeshes["floor-meshes-"+a.id];if(s&&s.data){a.setMeshNames(s.data);for(var r in s.data)i.meshIDToPath[parseInt(r,10)]={path:s.data[r],floor:n[o]}}var h=new Node("pois");for(var l in a.pois)a.pois[l].createGeometry(this.wayfinder.engine,this.wayfinder),a.pois[l].applySettings(this.wayfinder.settings),h.addNode(a.pois[l].object);a.node3D.addNode(h)}this.wayfinder.poiController=i,t.engine.assetsManager.texturesManager.load(function(){})},setupSkybox:function(t){var e=["scene.skybox.front","scene.skybox.back","scene.skybox.left","scene.skybox.right","scene.skybox.down","scene.skybox.up"],i=[],n=!1;for(var o in e){var a=this.wayfinder.settings.getInt(e[o],0);0!==a&&(n=!0);var s=new TextureDescriptor(a);s.loadAsImage=!0,i.push(s)}if(n){var r=t.cameraNode.addComponent(new SkyboxComponent);r.setup(t.engine.assetsManager,t.engine,i)}},setupYAH:function(t){var e=this.wayfinder.getKioskNode();if(e&&e.floor&&e.floor.node3D){var i=this.wayfinder.settings,n=i.getInt("kiosk.you-are-here-image",0);if(0!==n&&this.wayfinder.options.drawKioskIcon){var o=t.engine,a=new TextureDescriptor(n);a.loadAsImage=!0;var s=new Material(o.assetsManager.addShaderSource("Transparent"),{diffuse:new UniformColor(new Color)},[new Sampler("diffuse0",o.assetsManager.texturesManager.addDescriptor(a))]);s.name="YAH_icon",s.shader.requirements.transparent=!0;var r=i.getFloat("poi.width",1),h=i.getFloat("poi.height",1),l=Primitives.plane(r,h,s);l.name="YAH";var d=l.getComponent(MeshRendererComponent);d.castShadows=!1,d.lightContribution=0,d.disable(),l.addComponent(new MeshCollider),l.addComponent(new Billboard(t.camera,!0)),l.addComponent(new YAHComponent(e)).offsetY=i.getFloat("poi.3d.offset",0),i.getBoolean("path.animation.yah",!1)&&l.addComponent(new AnimationComponent),l.getComponent(AnimationComponent)&&(l.getComponent(AnimationComponent).setLowestPosition(i.getFloat("poi.3d.offset",0)),l.getComponent(AnimationComponent).setHighestPosition(i.getFloat("path.animation.yah-highest-position",5)),l.getComponent(AnimationComponent).setAnimationSpeed(i.getFloat("path.animation.yah-speed",1)),l.getComponent(AnimationComponent).startAnimating()),l.layer=Layers.POI;var c=new Node("YAHLocation");mat4.fromTranslation(c.transform.relative,e.position),c.addNode(l),e.floor.node3D.addNode(c)}}},overrideBuildingMaterials:function(){var t={};for(var e in this.wayfinder.materials)t[this.wayfinder.materials[e].id]={parsed:this.wayfinder.materials[e],material:!1};var i=this.wayfinder.engine;i.scene.root.onEachChildComponent(function(e){if(e instanceof MeshComponent){var n=e.node.path();n=n.substring(6),n=n.substring(0,n.indexOf("/"));var o=e.node.scene.root.findChildWithName(n),a=!1;if(o){var s=o.getComponent(FloorComponent);s&&(a=s.floor.model_id)}for(var r in e.mesh.materials){var h=e.mesh.materials[r],l=!1;for(var d in t)if(t[d].parsed.name===h.name){if(0===t[d].parsed.model_id){l=t[d];break}t[d].parsed.model_id===a&&(l=t[d])}if(l)if(l.material)e.mesh.materials[r]=l.material;else{for(var c in l.parsed.uniforms){var u=l.parsed.uniforms[c],f=u.value.split(" "),g=!1,p=!1;switch(u.type){case"int":g=new UniformInt(parseInt(u.value));break;case"float":g=new UniformFloat(parseFloat(u.value));break;case"vec2":p=vec2.create(),g=new UniformVec2(p);break;case"vec3":p=vec3.create(),g=new UniformVec3(p);break;case"color":case"vec4":p=vec4.create(),g=new UniformVec4(p);break;case"mat4":p=mat4.create(),g=new UniformMat4(p)}if(p){for(var d in f)p[d]=parseFloat(f[d]);g.value=p}g&&(h.uniforms[u.name]=g)}if(h.shader=i.assetsManager.addShaderSource(l.parsed.shader),h.uniforms.diffuse.value[3]<1&&(h.shader=i.assetsManager.addShaderSource("transparent")),l.parsed.textures instanceof Array)for(var m in l.parsed.textures){var y=l.parsed.textures[m],v=!1;for(var P in h.samplers)if(h.samplers[P].name==y.sampler&&h.samplers[P].texture.name!=y.name){var I=new TextureDescriptor(y.name),m=i.assetsManager.texturesManager.addDescriptor(I);h.samplers[P]=new Sampler(y.sampler,m)}if(!v){var I=new TextureDescriptor(y.name),m=i.assetsManager.texturesManager.addDescriptor(I);h.samplers.push(new Sampler(y.sampler,m))}}l.material=h}}}else if(e instanceof MeshRendererComponent){var n=e.node.path();n=n.substring(6),n=n.substring(0,n.indexOf("/"));var o=e.node.scene.root.findChildWithName(n),a=!1;if(o){var s=o.getComponent(FloorComponent);s&&(a=s.floor.model_id)}for(var r in e.meshRenderers){var h=e.meshRenderers[r].material,l=!1;for(var d in t)if(t[d].parsed.name===h.name){if(0===t[d].parsed.model_id){l=t[d];break}t[d].parsed.model_id===a&&(l=t[d])}l&&(("transparent"==l.parsed.shader||h.uniforms.diffuse.value[3]<1)&&(e.meshRenderers[r].transparent=!0),l.material&&(e.meshRenderers[r].material=l.material))}}}),i.assetsManager.load()}}),WayfinderLogic3D=Class.extend({init:function(t){this.wayfinder=t,this.engine=t.engine,this.currentFloor=!1},showPath:function(t,e,i,n,o){if(!this.wayfinder.pathComponent)throw"Cannot show path: Wayfinder has no PathComponent reference.";var a=this.wayfinder.nodes[e];if(!a)throw"Destination node not found.";console.log("Path from: "+t+" to "+e),console.log("destnode %o",a),this.stopAnimatingAllPOIs(a.id);var s={displayDestinationOnStart:n&&n.displayDestinationOnStart?!0:!1},r=new Date,h=r.getDay(),l=r.getHours(),d={},c={},u=[];for(var f in this.wayfinder.nodes){var g=this.wayfinder.nodes[f];if(this.wayfinder.attributes&&f in this.wayfinder.attributes&&"allowedTimes"in this.wayfinder.attributes[f]){var p,m=this.wayfinder.attributes[f];if(1==m.allowedTimes.length)p=m.allowedTimes[0];else{if(h>=m.allowedTimes.length){d[f]=g;continue}p=m.allowedTimes[h]}for(var y=0;y<p.length;y+=2)if(l>=p[y]&&l<p[y+1]){d[f]=g;break}f in d||u.push(f)}if(this.wayfinder.attributes&&f in this.wayfinder.attributes&&"inaccessibility"in this.wayfinder.attributes[f]){var v=this.wayfinder.attributes[f].inaccessibility;this.wayfinder.accessibility&&-1!=v.indexOf(this.wayfinder.accessibility)?(u.push(f),f in d&&delete d[f]):-1==u.indexOf(f)&&(d[f]=g)}-1==u.indexOf(f)&&(d[f]=g)}for(var f in this.wayfinder.edges){var P=this.wayfinder.edges[f];if(-1===u.indexOf(f)){for(var I=[],y=0;y<P.length;y++)-1==u.indexOf(P[y])&&I.push(P[y]);c[f]=I}}var w=new Pathfinder3D(d,c),C=w.find(t,e);this.wayfinder.showFloor(this.currentFloor);var b=this.wayfinder.poiController;b.clearHighlights(),b.clearDisplaying();var A=this;if(this.wayfinder.pathComponent.setPath(C,function(){var t=A.wayfinder.getKioskNode();if("function"==typeof o&&o(C,e,i),t&&t.floor&&t.floor.node3D){t.floor.node3D.find("YAHLocation/YAH")}}),s.displayDestinationOnStart&&(i?(b.setHighlights([i]),b.setDisplaying([i])):(b.setHighlights(a.pois),b.setDisplaying(a.pois))),this.wayfinder.settings.getBoolean("path.animation.poi",!0)){var W=i?i:a.pois[0];W.setAnimation(this.wayfinder.settings.getFloat("poi.3d.offset",0),this.wayfinder.settings.getFloat("path.animation.yah-highest-position",10),this.wayfinder.settings.getFloat("path.animation.yah-speed",.5)),W.startAnimating()}var O=A.wayfinder.getKioskNode();if(!O||!O.floor||!O.floor.node3D)return C;var S=O.floor.node3D.find("YAHLocation/YAH");if(!S)return C;var M=S.getComponent(AnimationComponent);return M&&M.startAnimating(),C},showFloor:function(t,e,i){function n(){function t(t){t instanceof RendererComponent&&t.disable()}if(l.currentFloor!==!1)for(var e in d)d[e].index>l.currentFloor.index&&d[e].node3D.onEachChildComponent(t)}function o(){c.inflight--,0===c.inflight&&(i||(t.showYAH(),l.showFloorPOIs(l.currentFloor),l.showPathMeshes(l.currentFloor),n()),e&&e(t))}function a(t){t.onEachChild(r),o(t)}function s(t){if(!t.getComponent(POIComponent)&&!t.getComponent(YAHComponent)){var e=t.getComponent(RendererComponent);e&&(e.castShadows=!1)}}function r(t){if(!t.getComponent(POIComponent)&&!t.getComponent(YAHComponent)){var e=t.getComponent(RendererComponent);e&&(e.castShadows=!0)}}function h(t){if(!t.getComponent(POIComponent)&&!t.getComponent(YAHComponent)){var e=t.getComponent(RendererComponent);e&&e.enable()}}if(t instanceof Floor){var l=this,d=this.wayfinder.building.getSortedFloors(),c={};if(c.inflight=0,this.currentFloor instanceof Floor&&(this.hideFloorPOIs(this.currentFloor),this.currentFloor===t&&this.showFloorPOIs(this.currentFloor)),this.currentFloor=t,this.wayfinder.pathComponent&&this.wayfinder.settings.getBoolean("path.3d.hide-above",!0)){var u=this.wayfinder.pathComponent.getInstancesAboveFloor(this.currentFloor);for(var f in u)u[f][0].disable(),u[f][1].disable(),u[f][2].disable()}for(var f in d){var g=d[f];c.inflight++,g.index>t.index?(g.node3D.onEachChild(s),g.node3D.getComponent(FloorFlightComponent).fly(o)):(g.node3D.onEachChild(h),g.node3D.getComponent(FloorFlightComponent).land(a))}}},showFloorPOIs:function(t){this.hideAllPOIs(),t.showYAH(),this.wayfinder.poiController.showPOIs(t.pois)},hideFloorPOIs:function(t){t.hideYAH(),this.wayfinder.poiController.hidePOIs(t.pois)},hideAllPOIs:function(){var t=this.wayfinder.building.getFloors(),e=this.wayfinder.poiController;for(var i in t)t[i].hideYAH();e.hidePOIs(this.pois)},stopAnimatingAllPOIs:function(t){{var e=this.wayfinder.poiController;this.wayfinder.building.getFloors()}e.stopAnimatingPOIs(this.wayfinder.pois,t)},showPathMeshes:function(t){var e=this.wayfinder.pathComponent;if(e&&e.finished){var i=e.getInstancesBelowFloor(t);for(var n in i)i[n][0].enable();i=e.getInstancesAtFloor(t);for(var n in i)i[n][0].enable()}},setDefaultView:function(t){this.wayfinder.pathComponent&&this.wayfinder.pathComponent.clearPath(),this.setKioskView(t)},setKioskView:function(t){this.wayfinder.clearHighlights(),this.wayfinder.clearDisplaying();var e=this.wayfinder.orbitController,i=vec3.fromValues(this.wayfinder.settings.getFloat("camera.target.x",0),this.wayfinder.settings.getFloat("camera.target.y",0),this.wayfinder.settings.getFloat("camera.target.z",0)),n=this.wayfinder.getKioskNode();this.setNormalRotation(),e&&(vec3.set(e.pan,0,0,0),t?(e.setZoom(t),vec3.add(i,n.position,i),e.target.value.setPosition(i)):n.zoom?(e.setDistance(n.zoom),vec3.add(i,n.position,i),e.target.value.setPosition(i)):this.fitToView(),n&&n.floor&&this.wayfinder.showFloor(n.floor),this.wayfinder.onZoomChange(e.getZoom()))},setNodeView:function(t,e){var i=this.wayfinder.orbitController;if(i&&i.target&&!i.target.isNull()&&t){this.setNormalRotation();var n=vec3.create();vec3.add(n,n,t.position),vec3.scale(n,n,.5),vec3.scale(n,n,wayfinder.options.zoomPadding);var o=new BoundingSphere(n,t.position);o.encapsulateSphere(t.position),vec3.set(i.pan,0,0,0),i.target.value.setPosition(o.center),e?i.setZoom(e):t.zoom?i.setDistance(t.zoom):this.fitToView(),this.wayfinder.showFloor(t.floor)}},fitToView:function(){var t=this.wayfinder.orbitController;if(t&&t.target&&!t.target.isNull()){var e=this.wayfinder.engine.scene;e.root.updateChildTransforms();var i=e.root.getBoundingBox(!0),n=vec3.fromValues(0,0,1),o=quat.identity(quat.create());quat.rotateY(o,o,t.rotation[1]),quat.rotateX(o,o,t.rotation[0]),vec3.transformQuat(n,n,o),vec3.negate(n,n),vec3.normalize(n,n);var a=new Plane;a.setByNormalAndPoint(n,i.center);var s=i.getVertices();for(var r in s)s[r]=a.projectToPlane(s[r]);var h=vec3.create(),l=vec3.create();vec3.copy(h,s[0]),vec3.copy(l,s[0]);for(var d=1;8>d;d++)for(var r=0;3>r;r++)s[d][r]<h[r]&&(h[r]=s[d][r]),s[d][r]>l[r]&&(l[r]=s[d][r]);var c=vec3.cross(vec3.create(),a.normal,[1,0,0]),u=vec3.cross(vec3.create(),c,a.normal);vec3.normalize(u,u),vec3.normalize(c,c);var d=vec3.sub(vec3.create(),l,h);this.wayfinder.options||(this.wayfinder.options=1.05);var f=1.05*Math.max(vec3.dot(u,d),vec3.dot(c,d)),g=Math.min(e.cameraComponent.getVerticalFieldOfView(),e.cameraComponent.getHorizontalFieldOfView())*Math.PI/180;t.setDistance(f/Math.sin(g/2)-f)}},setNormalRotation:function(){var t=this.wayfinder.orbitController,e=this.wayfinder.getKioskNode();if(t)if(e){t.rotation[0]=-e.rotation[0]/180*Math.PI;var i=Math.floor(Math.abs(t.currentRotation[1])/(2*Math.PI));t.currentRotation[1]<2*Math.PI?t.currentRotation[1]+=2*i*Math.PI:t.currentRotation[1]-=2*i*Math.PI;var n=e.rotation[1]/180*Math.PI;t.rotation[1]=t.currentRotation[1]>n+Math.PI?n+2*Math.PI:t.currentRotation[1]<n-Math.PI?n-2*Math.PI:n}else t.rotation[0]=t.minimumPitch,t.rotation[1]=0},getNearestPOI:function(t,e){function i(t){var e=t.length;if(2>e)return!1;for(var i=0,o=1;e>o;++o)i+=vec3.distance(n[t[o-1]].position,n[t[o]].position);return i}var n=this.wayfinder.nodes,o=this.wayfinder.edges;if(0==e.length||!(t in n))return null;var a=new Pathfinder3D(n,o),s=n[t];e.sort(function(t,e){var i=t.getNode(),n=e.getNode();if(!i&&!n)return 0;if(!i)return 1;if(!n)return-1;var o=vec3.squaredDistance(t.getNode().position,s.position),a=vec3.squaredDistance(e.getNode().position,s.position);return o-a});for(var r,h,l=1/0,d=null,c=e.length,u=0;c>u;++u)if(r=a.find(t,e[u].getNode().id),h=i(r),h!==!1){if(!(l>h))break;l=h,d=e[u]}return d}}),FloorComponent=Component.extend({init:function(t){this._super(),this.floor=!1,t instanceof Floor3D&&(this.floor=t)},type:function(){return"FloorComponent"}}),FloorFlightComponent=Component.extend({init:function(){this._super("Floor Flight Component"),this.flightAltitude=500,this.flightMultiplier=5,this.originalRelative=!1,this.originalPosition=!1,this.flying=!1,this.readyCallbacks=[]},type:function(){return"FloorFlightComponent"},fly:function(t){this.originalPosition||(this.originalRelative=mat4.clone(this.node.transform.relative),this.originalPosition=mat4.translation(vec3.create(),this.node.transform.relative)),this.flying=!0,this.flightSpeed=0,t&&this.readyCallbacks.push(t)},land:function(t){this.originalPosition||(this.originalRelative=mat4.clone(this.node.transform.relative),this.originalPosition=mat4.translation(vec3.create(),this.node.transform.relative)),this.flying=!1,this.flightSpeed=0,t&&this.readyCallbacks.push(t)},isInPlace:function(){var t=mat4.translation(vec3.create(),this.node.transform.relative);return this.flying&&t[1]>=this.originalPosition[1]+this.flightAltitude||!this.flying&&t[1]<=this.originalPosition[1]},callReadyCallbacks:function(){if(0!=this.readyCallbacks.length){for(var t in this.readyCallbacks){var e=this.readyCallbacks[t];e(this.node)}this.readyCallbacks=[]}},onUpdate:function(t){if(this.originalPosition){var e=mat4.translation(vec3.create(),this.node.transform.relative),i=0,n=e[1]-this.originalPosition[1];this.flying?e[1]<this.originalPosition[1]+this.flightAltitude?i=1+this.flightMultiplier*n:this.callReadyCallbacks():e[1]>this.originalPosition[1]?i=-(1+this.flightMultiplier*n):this.callReadyCallbacks(),mat4.translate(this.node.transform.relative,this.node.transform.relative,[0,t.fps.getDelta()/1e3*i,0]);var e=mat4.translation(vec3.create(),this.node.transform.relative);e[1]<this.originalPosition[1]&&(this.node.transform.relative=mat4.clone(this.originalRelative))}}}),PathComponent=Component.extend({init:function(t,e){function i(t,i){var n=e.settings.getModel(t,0);if(n>0){var o=new ModelDescriptor(WayfinderAPI.models.model.url(n),"data");return o}return i}this._super(),this.wayfinder=e,this.nodes=t,this.speed=10,this.stepDistance=.5,this.floorPause=0,this.liftStepDistance=.5,this.liftingDistance=1,this.position=0,this.finished=!1,this.paused=!1,this.floorTime=0,this.floorPaused=!1,this.followPath=!1,this.currentPathNode=!1,this.targetPosition=vec3.create(),this.targeting=!1,this.pathMeshSources={start:i("path.3d.model.start","models/PathStart.data"),middle:i("path.3d.model.middle","models/PathMiddle.data"),end:i("path.3d.model.end","models/PathEnd.data"),active:i("path.3d.model.active","models/PathMiddle.data"),liftUp:i("path.3d.model.liftup","models/PathLiftUp.data"),liftUpIn:i("path.3d.model.liftupin","models/PathLiftUp.data"),liftUpOut:i("path.3d.model.liftupout","models/PathLiftUp.data"),liftDown:i("path.3d.model.liftdown","models/PathLiftDown.data"),liftDownIn:i("path.3d.model.liftdownin","models/PathLiftDown.data"),liftDownOut:i("path.3d.model.liftdownout","models/PathLiftDown.data"),prestart:i("path.3d.model.prestart","models/PathStart.data"),premiddle:i("path.3d.model.premiddle","models/PrePathMiddle.data"),preend:i("path.3d.model.preend","models/PathEnd.data"),preliftUp:i("path.3d.model.preliftup","models/PathPreLiftUp.data"),preliftUpIn:i("path.3d.model.preliftupin","models/PathPreLiftUp.data"),preliftUpOut:i("path.3d.model.preliftupout","models/PathPreLiftUp.data"),preliftDown:i("path.3d.model.preliftdown","models/PathPreLiftDown.data"),preliftDownIn:i("path.3d.model.preliftdownin","models/PathPreLiftDown.data"),preliftDownOut:i("path.3d.model.preliftdownout","models/PathPreLiftDown.data"),belowstart:"models/PathStart.data",belowmiddle:"models/PathMiddle.data",belowend:"models/PathStart.data",belowliftUp:"models/PathLiftUp.data",belowliftUpIn:"models/PathLiftUp.data",belowliftUpOut:"models/PathLiftUp.data",belowliftDown:"models/PathLiftDown.data",belowliftDownIn:"models/PathLiftDown.data",belowliftDownOut:"models/PathLiftDown.data"},this.pathMeshes={},this.resetStructures()},type:function(){return"PathComponent"},resetStructures:function(){this.path=!1,this.totalPathLength=0,this.floor=!1,this.cbOnFinish=!1,this.pathMeshFloors=[],this.pathMeshInstances=[],this.pathWaitingInstances=[],this.position=0,this.floorPause=0,this.floorTime=0,this.floorPaused=!1},onStart:function(t,e){for(var i in this.pathMeshSources){var n=this.pathMeshSources[i];this.pathMeshes[i]=n instanceof ModelDescriptor?e.assetsManager.modelsManager.addDescriptor(n):e.assetsManager.addModel(n)}var o=this;e.assetsManager.load(function(){for(var t in o.pathMeshes)o.pathMeshes[t].onEachChildComponent(function(t){t instanceof RendererComponent&&(t.castShadows=!1,t.lightContribution=0)})})},setPath:function(t,e){if(this.clearPath(),this.path=t,this.cbOnFinish=e,this.finished=!1,this.stepDistance=this.wayfinder.settings.getFloat("path.3d.stride",1),this.speed=this.wayfinder.settings.getFloat("path.3d.speed",10),this.floorPause=this.wayfinder.settings.getFloat("path.floor.pause",0),this.followPath=this.wayfinder.settings.getBoolean("path.3d.follow-path",!1),this.wayfinder.settings.getBoolean("camera.first-person.enabled",!1)){this.speed=this.wayfinder.settings.getFloat("camera.first-person.speed",2);var i=this.node.scene.cameraComponent.node.getComponent(OrbitController);i&&(this._minimumDistance=i.minimumDistance,i.minimumDistance=this.wayfinder.settings.getFloat("camera.first-person.eye-height",1.68))}var n=this.wayfinder.settings.getFloat("path.3d.size",1),o=vec3.fromValues(n,n,n);if(t){if(t.length<2)return;var a=this,s=function(t,e,i,n,s){function r(t){var e=a.pathMeshes[t],r=e.instantiate();return r.transform.translate(i),r.transform.scale(o),n&&r.transform.rotate(n,[0,1,0]),a.node.addNode(r),r.pathNode=s,r}var h=r(e),l=r("pre"+e),d=r("below"+e),c=r("active");h.disable(),d.disable(),c.disable();var u=[h,l,d,c];return a.pathMeshInstances.push(u),a.pathWaitingInstances.push(u),a.pathMeshFloors.push(t),h},r=function(t,e,i,n,o,r,h){for(var l=vec3.subtract(vec3.create(),n,i),d=o,c=a.stepDistance,u=vec3.length(l);u-r>d;)s(t,e,vec3.add(vec3.create(),i,vec3.scale(vec3.create(),l,d/u)),Math.PI/2-Math.atan2(l[2],l[0]),h),d+=c;return d-u-r},h=this.nodes[t[0]],l=this.nodes[t[t.length-1]];s(h.floor,"start",h.position,!1,h);for(var d=this.nodes[t[0]].position,c=a.stepDistance,u=1;u<t.length;u++){var f=this.nodes[t[u]];if(f){var g=f.floor,p=f.position,m=vec3.subtract(vec3.create(),p,d);this.totalPathLength+=vec3.length(m),vec2.length(vec2.fromValues(m[0],m[2]))<2*this.stepDistance&&m[1]>this.liftingDistance?(c=0,this.liftStepDistance?c=r(g,"liftUp",d,p,c,0,f):s(g,"liftUp",d,!1,f)):vec2.length(vec2.fromValues(m[0],m[2]))<2*this.stepDistance&&m[1]<-this.liftingDistance?(c=0,this.liftStepDistance?c=r(g,"liftDown",d,p,c,0,f):s(g,"liftDown",p,!1,f)):c=r(g,"middle",d,p,c,u+1==t.length?a.stepDistance/2:0,f),d=p}}s(l.floor,"end",l.position,!1,l)}this.showCurrentFloor(!1),this.node.updateChildTransforms(),this.wayfinder.settings.getBoolean("path.3d.top-down",!1)&&this.setTopView(),this.followPath||this.zoomOnPath(this.node.getBoundingSphere(),h.position)},clearPath:function(){this.resetStructures(),this.node.removeSubnodes()},setTopView:function(){var t=this.node.scene.cameraComponent.node.getComponent(OrbitController);if(t&&t.target&&!t.target.isNull()){t.rotation[0]=-1.53588974,t.rotation[2]=0;var e=this.wayfinder.getKioskNode();e&&e.zoom&&t.setDistance(e.zoom)}},zoomOnPath:function(t,e){if(t){var i=this.node.scene.cameraComponent.node.getComponent(OrbitController);if(i&&i.target&&!i.target.isNull()){this.previousRotationSpeed||(this.previousRotationSpeed=i.speed,i.speed=this.wayfinder.settings.getFloat("path.3d.camera-speed",2));var n=vec3.create();vec3.sub(n,e,t.center),vec3.scale(n,n,2/3),vec3.add(n,t.center,n);var o=new BoundingSphere(n,t.radius);o.encapsulateSphere(t),vec3.set(i.pan,0,0,0),vec3.copy(this.targetPosition,o.center),this.targeting=!0;var a=2.2*o.radius,s=Math.min(this.node.scene.cameraComponent.getVerticalFieldOfView(),this.node.scene.cameraComponent.getHorizontalFieldOfView())*Math.PI/180;i.setDistance(.5*(a/Math.sin(s/2)-o.radius));var r=this.wayfinder.getKioskNode();if(r&&!this.wayfinder.settings.getBoolean("path.3d.top-down",!1)){i.rotation[0]=-r.rotation[0]/180*Math.PI;var h=Math.floor(Math.abs(i.currentRotation[1])/(2*Math.PI));i.currentRotation[1]<2*Math.PI?i.currentRotation[1]+=2*h*Math.PI:i.currentRotation[1]-=2*h*Math.PI;var l=r.rotation[1]/180*Math.PI;i.rotation[1]=i.currentRotation[1]>l+Math.PI?l+2*Math.PI:i.currentRotation[1]<l-Math.PI?l-2*Math.PI:l}else i.rotation[0]=-1.53588974;this.wayfinder.cbOnZoomChange&&"function"==typeof this.wayfinder.cbOnZoomChange&&this.wayfinder.cbOnZoomChange(i.getZoom())}}},moveOnPoint:function(t,e){var i=this.node.scene.cameraComponent.node.getComponent(OrbitController);if(i&&i.target&&!i.target.isNull()){var n=t.transform.getPosition(),o=i.target.value.getPosition();vec3.lerp(o,o,n,Math.min(1,e*i.speed)),i.target.value.setPosition(o)}},zoomOnPoint:function(t){if(t){var e=this.node.scene.cameraComponent.node.getComponent(OrbitController);if(e&&e.target&&!e.target.isNull()){var i=this.position/6,n=!1;if(!(Math.floor(i)+1>=this.path.length)){Math.floor(i)+2==this.path.length&&(n=!0);var o=this.nodes[this.path[Math.floor(i)]].position,a=this.nodes[this.path[Math.floor(i+1)]].position,s=null;n||(s=this.nodes[this.path[Math.floor(i+2)]].position);var r=vec3.create();vec3.sub(r,a,o);var h=vec3.sub(vec3.create(),a,o),l=null;n||(l=vec3.sub(vec3.create(),s,a)),vec3.scale(r,r,i-Math.floor(i)),vec3.add(r,o,r),r[1]+=this.wayfinder.settings.getFloat("camera.first-person.eye-height",1.68);var d=new BoundingSphere(r,t.radius);vec3.set(e.pan,0,0,0),e.target.value.setPosition(d.center);{2.2*d.radius,Math.min(this.node.scene.cameraComponent.getVerticalFieldOfView(),this.node.scene.cameraComponent.getHorizontalFieldOfView())*Math.PI/180}e.setDistance(0),e.rotation[0]=0;var c=3*Math.PI/2-Math.atan2(h[2],h[0]);c+=Math.PI,c%=2*Math.PI,c-=Math.PI;var u=c,f=0;if(!n){for(f=3*Math.PI/2-Math.atan2(l[2],l[0]),f+=Math.PI,f%=2*Math.PI,f-=Math.PI;Math.abs(f-c)>Math.PI;)0>f-c?f+=2*Math.PI:c+=2*Math.PI;u=c+(f-c)*(i-Math.floor(i)),u+=Math.PI,u%=2*Math.PI,u-=Math.PI}for(;Math.abs(u-e.rotation[1])>Math.PI;)u-e.rotation[1]<0?u+=2*Math.PI:u-=2*Math.PI;e.rotation[1]=u,this.wayfinder.cbOnZoomChange&&"function"==typeof this.wayfinder.cbOnZoomChange&&this.wayfinder.cbOnZoomChange(e.getZoom())}}}},zoomBetweenNodes:function(t,e){if(t&&e){var i=this.node.scene.cameraComponent.node.getComponent(OrbitController);if(!i||!i.target||i.target.isNull())return;var n=Math.min(this.node.scene.cameraComponent.getVerticalFieldOfView(),this.node.scene.cameraComponent.getHorizontalFieldOfView())*Math.PI/180;distance=vec3.create(),vec3.sub(distance,t.position,e.position);var o=1.1*vec3.length(distance);i.setDistance(o/Math.sin(n/2)-o),this.wayfinder.cbOnZoomChange&&"function"==typeof this.wayfinder.cbOnZoomChange&&this.wayfinder.cbOnZoomChange(i.getZoom())}},onUpdate:function(t){if(this.path&&!this.paused&&!this.finished){var e=t.fps.getDelta()/1e3;if(this.floorPaused)return void this.showCurrentFloor(e);var i=this.node.scene.cameraComponent.node.getComponent(OrbitController);if(i&&this.targeting){var n=vec3.create();i.target.value.getPosition(n),vec3.lerp(n,n,this.targetPosition,Math.min(1,e*i.speed)),i.target.value.setPosition(n)}var o=this.position;this.position+=e*this.speed,(this.position>this.pathMeshInstances.length&&(!this.wayfinder.settings.getBoolean("camera.first-person.enabled",!1)||this.wayfinder.settings.getBoolean("camera.first-person.show-path",!0))||this.wayfinder.settings.getBoolean("camera.first-person.enabled",!1)&&!this.wayfinder.settings.getBoolean("camera.first-person.show-path",!0)&&this.position/6>this.path.length)&&(this.finished=!0,this.wayfinder.settings.getBoolean("camera.first-person.enabled",!1)&&i&&(i.minimumDistance=this._minimumDistance,this.wayfinder.setDefaultView()),this.onPathFinished(this.path),this.cbOnFinish&&this.cbOnFinish());var a=!0;if(this.wayfinder.settings.getBoolean("camera.first-person.enabled",!1)&&!this.wayfinder.settings.getBoolean("camera.first-person.show-path",!0)&&(a=!1),a){for(var s=Math.floor(o),r=Math.floor(this.position)-Math.floor(o)+s;s<=Math.floor(this.position)&&!(s>=this.pathMeshInstances.length);s++)s==r?this.pathMeshInstances[s][3].enable():(this.pathMeshInstances[s][0].enable(),this.pathMeshInstances[s][3].disable()),this.pathMeshInstances[s][0].pathNode!=this.currentPathNode&&(this.currentPathNode=this.pathMeshInstances[s][0].pathNode,this.wayfinder.cbOnPathStep(this.pathMeshInstances[s][0].pathNode)),this.pathMeshInstances[s][1].disable(),this.pathWaitingInstances.shift();s<this.pathMeshInstances.length&&this.followPath&&this.moveOnPoint(this.pathMeshInstances[s][0],e)}this.wayfinder.settings.getBoolean("camera.first-person.enabled",!1)&&!this.finished&&this.zoomOnPoint(this.node.getBoundingSphere()),this.showCurrentFloor(e)}},onPathFinished:function(t){if(this.targeting=!1,this.previousRotationSpeed){var e=this.node.scene.cameraComponent.node.getComponent(OrbitController);if(e){var i=this.node.scene.engine.fps.getDelta()/1e3*e.speed*2;i=Math.min(i,1),e.rotation[0]=lerp(e.currentRotation[0],e.rotation[0],i),e.rotation[1]=lerp(e.currentRotation[1],e.rotation[1],i),e.distance=lerp(e.currentDistance,e.distance,i),e.speed=this.previousRotationSpeed}delete this.previousRotationSpeed}"function"==typeof this.wayfinder.cbOnPathFinished&&this.wayfinder.cbOnPathFinished(t)},showCurrentFloor:function(t){var e=Math.floor(this.position);if(!(e>=this.pathMeshInstances.length||this.floor==this.pathMeshFloors[e]&&!this.floorPaused)){if(!this.floorPaused){var i=this.floor;this.floor=this.pathMeshFloors[e],this.wayfinder.cbOnBeforeFloorChange&&i&&this.wayfinder.cbOnBeforeFloorChange(i,this.floor,this.pathMeshFloors[this.pathMeshFloors.length-1])}if(t){if(this.floorPaused=!0,this.floorTime+=t,this.floorTime<this.floorPause)return;this.floorPaused=!1,this.floorTime=0}var n=this;this.paused=!0,this.wayfinder.showFloor(this.floor,function(t){n.wayfinder.cbOnFloorChange&&n.wayfinder.cbOnFloorChange(t),n.paused=!1})}},getInstancesAtFloor:function(t){var e=[];for(var i in this.pathMeshFloors)this.pathMeshFloors[i]===t&&e.push(this.pathMeshInstances[i]);return e},getInstancesBelowFloor:function(t){var e=[];for(var i in this.pathMeshFloors)this.pathMeshFloors[i].index<t.index&&e.push(this.pathMeshInstances[i]);return e},getInstancesAboveFloor:function(t){var e=[];for(var i in this.pathMeshFloors)this.pathMeshFloors[i].index>t.index&&e.push(this.pathMeshInstances[i]);return e},zoomOnPathSegment:function(t,e){for(var i=0;i<this.pathMeshInstances.length;i++)if(this.pathMeshInstances[i][0].pathNode==e)return this.position=i,this.showCurrentFloor(100),this.moveOnPoint(this.pathMeshInstances[i][0],1e3),void this.zoomBetweenNodes(t,e)}}),ScreensaverComponent=Component.extend({init:function(t){this._super(),this.wayfinder=t,this.destination=!1,this.destNodeID=-1,this.waitTime=1,this.waitedTime=0,this.preWaitedTime=0,this.distance=0,this.minimumDistance=0,this.originalDistance=1,this.paused=!1,this.movementSpeed=5,this.finishFunction=!1},type:function(){return"ScreensaverComponent"},setDestination:function(t,e,i){this.destination=t,this.destNodeID=e,this.finishFunction=i,this.waitedTime=0,this.preWaitedTime=0,this.movementSpeed=this.wayfinder.settings.getFloat("kiosk.screensaver.speed",5);

var n=this.node.scene.cameraComponent.node.getComponent(OrbitController);if(n&&n.target&&!n.target.isNull()){var o=vec3.sub(vec3.create(),this.destination.position,n.target.value.getPosition());this.distance=vec3.length(o),this.minimumDistance=n.minimumDistance,this.originalDistance=n.distance-this.minimumDistance,this.showCurrentFloor()}},clearDestination:function(){this.destination=!1,this.finFun&&this.finFun()},onUpdate:function(t){if(this.destination&&!this.paused){var e=t.fps.getDelta()/1e3,i=this.node.scene.cameraComponent.node.getComponent(OrbitController);if(!i||!i.target||i.target.isNull())return;if(i.rotation[0]=-1,this.preWaitedTime<this.waitTime)return void(this.preWaitedTime+=e);var n=this.destination.position,o=this.movementSpeed*e,a=vec3.sub(vec3.create(),n,i.target.value.getPosition());if(vec3.length(a)<o){if(i.target.value.setPosition(n),this.waitedTime+=e,this.waitedTime>this.waitTime)return this.finFun&&this.finFun(),void this.wayfinder.showScreensaver()}else{var s=vec3.normalize(vec3.create(),a);vec3.scale(s,s,o);var r=vec3.add(vec3.create(),i.target.value.getPosition(),s);i.target.value.setPosition(r)}i.setDistance(this.minimumDistance+this.originalDistance*(vec3.length(a)/this.distance))}},showCurrentFloor:function(){var t=this;t.paused=!0,this.wayfinder.showFloor(this.destination.floor,function(){t.paused=!1})}}),DistanceScalingComponent=Component.extend({init:function(t){if(this._super(),this.camera=t,!(this.camera instanceof Camera))throw"DistanceScalingComponent.camera is not an instance of Camera";this.minScale=1,this.maxScale=15,this.doingIt=!0,this.v=vec3.create(),this.cameraPosition=vec3.create(),this.localPosition=vec3.create(),this.localRotation=quat.create()},type:function(){return"DistanceScalingComponent"},onUpdate:function(){if(this.enabled&&this.doingIt){this.node.transform.getPosition(this.v),this.camera.getPosition(this.cameraPosition),vec3.sub(this.v,this.v,this.cameraPosition);var t=.1*vec3.len(this.v);t=t<this.minScale?this.minScale:t>this.maxScale?this.maxScale:t,vec3.set(this.v,t,t,t),mat4.translation(this.localPosition,this.node.transform.relative),quat.fromMat4(this.localRotation,this.node.transform.relative),mat4.fromRotationTranslationScale(this.node.transform.relative,this.localRotation,this.localPosition,this.v)}}}),AnimationComponent=Component.extend({init:function(){this._super(),this.lowestPosition=vec3.create(),this.highestPosition=vec3.create(),this.animationPositions=[vec3.create(),vec3.create()],this.animating=!1,this.t=0,this.animationSpeed=1,this.direction=1,this.finish=!1,this.defaultPosition=vec3.create(),this.localPosition=vec3.create(),this.localRotation=quat.create(),this.localScale=vec3.create(),this.timeout=1e4},type:function(){return"AnimationComponent"},startAnimating:function(){this.animating||(this.t=0,this.direction=1,this.animating=!0,mat4.decompose(this.defaultPosition,this.localRotation,this.localScale,this.node.transform.relative),vec3.add(this.animationPositions[0],this.lowestPosition,this.defaultPosition),vec3.add(this.animationPositions[1],this.highestPosition,this.defaultPosition),this.finish=!1)},stopAnimating:function(){this.animating&&(this.animating=!1,this.finish=!0,mat4.fromRotationTranslationScale(this.node.transform.relative,this.localRotation,this.defaultPosition,this.localScale))},finishAnimating:function(){this.finish=!0},onUpdate:function(t){if(this.enabled&&this.animating){if(mat4.decompose(this.localPosition,this.localRotation,this.localScale,this.node.transform.relative),vec3.lerp(this.localPosition,this.animationPositions[0],this.animationPositions[1],this.t),this.t+=t.fps.getDelta()*this.animationSpeed*.001,this.t>=1){if(this.finish&&this.direction<0)return;this.animationPositions.reverse(),this.t=0,this.direction*=-1}mat4.fromRotationTranslationScale(this.node.transform.relative,this.localRotation,this.localPosition,this.localScale)}},setLowestPosition:function(t){this.lowestPosition=vec3.fromValues(0,t,0)},setHighestPosition:function(t){this.highestPosition=vec3.fromValues(0,t,0)},setAnimationSpeed:function(t){this.animationSpeed=t},setAnimationTime:function(t){this.timeout=t}}),POIComponent=Component.extend({init:function(t,e,i){this._super(),this.poi=!1,t instanceof POI3D&&(this.poi=t),this.debugLine=i,this.kioskNode=e,this.highlightDuration=5,this.highlightSpeed=1,this.highlightColors=[vec4.fromValues(1,0,0,1),vec4.fromValues(1,1,0,1)],this.dehighlightColor=vec4.fromValues(0,0,0,1),this.highlighting=!1,this.dehighlighting=!1,this.t=0,this.originalMaterial=!1,this.currentColor=new UniformVec4([1,1,1,1]),this.offsetY=0,this.width=1,this.height=1,this.textSize=1,this.textColor=new Color(1,1,1,1),this.outlineColor=new Color(0,0,0,0),this.outlineWidth=5,this.outline=!0,this.backgroundColor=new Color(0,0,0,0),this.groupColor=null,this.disableBillboard=!1,this.billboardClickable=!0,this.heightFromFloor=!0},type:function(){return"POIComponent"},excluded:function(){return["originalMaterial"]},dehighlight:function(){if(this.poi&&this.poi.submesh){this.dehighlighting=!0,this.startTime=(new Date).getTime();var t=this.poi.meshNode.getComponent(MeshRendererComponent),e=t.getSubmeshRenderer(this.poi.submesh);e&&e.material&&"diffuse"in e.material.uniforms&&(this.originalMaterial=e.material,this.dehighlightColor[3]=this.originalMaterial.uniforms.diffuse.value[3],vec4.copy(this.currentColor.value,this.dehighlightColor),e.material=e.material.instantiate(),e.material.uniforms.diffuse=this.currentColor)}},startHighlight:function(){if(this.poi&&this.poi.submesh){this.highlighting=!0,this.startTime=(new Date).getTime(),this.t=0;var t=this.poi.meshNode.getComponent(MeshRendererComponent),e=t.getSubmeshRenderer(this.poi.submesh);if(e&&e.material&&"diffuse"in e.material.uniforms){this.originalMaterial=e.material;for(var i in this.highlightColors)this.highlightColors[i][3]=this.originalMaterial.uniforms.diffuse.value[3];vec4.copy(this.currentColor.value,this.highlightColors[0]),e.material=e.material.instantiate(),e.material.uniforms.diffuse=this.currentColor}}},stopHighlight:function(){if(this.highlighting=!1,this.dehighlighting=!1,this.originalMaterial!==!1){var t=this.poi.meshNode.getComponent(MeshRendererComponent),e=t.getSubmeshRenderer(this.poi.submesh);e&&(e.material=this.originalMaterial),this.originalMaterial=!1}},onUpdate:function(t){if(this.highlighting||this.dehighlighting){var e=(new Date).getTime();(e-this.startTime<=1e3*this.highlightDuration||Math.abs(this.highlightDuration)<1e-5)&&this.highlighting&&(vec4.lerp(this.currentColor.value,this.highlightColors[0],this.highlightColors[1],this.t),this.t+=t.fps.getDelta()*this.highlightSpeed*.001,this.t>=1&&(this.highlightColors.reverse(),this.t=0))}},onStart:function(){if(this.poi){this.poi.linkMesh();var t=vec3.fromValues(this.width,this.height,1),e=this.node.getComponent(TextComponent);if(e&&(e.color=this.textColor,e.backgroundColor=this.backgroundColor,e.outline=this.outline,e.outlineColor=this.outlineColor,e.outlineWidth=this.outlineWidth,e.updateText(),vec3.set(t,this.textSize,this.textSize,this.textSize)),this.poi.meshNode&&this.disableBillboard)this.positionToMeshCenter();else if(this.heightFromFloor){var i=this.poi.floor.node3D.getBoundingBox(),n=new Plane;n.setByNormalAndPoint([0,-1,0],i.max);var o=n.getDistanceToPoint(this.poi.node.position);0>o&&(o=0),mat4.fromRotationTranslationScale(this.node.transform.relative,quat.create(),[0,o+this.offsetY,0],t)}else mat4.fromRotationTranslationScale(this.node.transform.relative,quat.create(),[0,this.offsetY,0],t);if(this.groupColor&&this.poi.meshNode){var a=this.poi.meshNode.getComponent(MeshRendererComponent),s=a.getSubmeshRenderer(this.poi.submesh);if(s){var r=s.material;if(r&&r.uniforms&&"diffuse"in r.uniforms){var h=r.instantiate();s.material=h,vec4.copy(h.uniforms.diffuse.value,this.groupColor)}}}}},getConcaveHull:function(){function t(t,e){var i=t[0]*e[1]-t[1]*e[0];return Math.atan2(i,vec2.dot(t,e))}function e(e,i,n){for(var o=1e20,a=-1,s=0;s<n.length;s++){var r=vec2.normalize(vec2.create(),vec2.sub(vec2.create(),h[i],h[n[s]])),l=t(e,r);o>l&&(o=l,a=n[s])}return a}function i(t){for(var e=[],i=0;i<l.length;i+=3)for(var n=0;3>n;n++)if(l[i+n]==t){-1==e.indexOf(l[i+(n+1)%3])&&e.push(l[i+(n+1)%3]),-1==e.indexOf(l[i+(n+2)%3])&&e.push(l[i+(n+2)%3]);break}return e}function n(t,n,o){var a=i(t),s=new Array;for(var r in a)-1==o.indexOf(a[r])&&s.push(a[r]);return e(n,t,s)}if(this.poi.submesh){var o=this.poi.meshNode.getComponent(MeshRendererComponent),a=o.getSubmeshRenderer(this.poi.submesh),s=a.submesh,r=a.matrix,h=(this.poi.node.rotation?this.poi.node.rotation[1]*Math.PI/180:0,[]);if(s.faces){for(var l=s.faces.slice(),d=(mat2.create(),vec3.create(),0);d<s.positions.length;d+=3){var c=vec3.transformMat4(vec3.create(),vec3.fromValues(s.positions[d],s.positions[d+1],s.positions[d+2]),r);h.push(vec2.fromValues(c[0],c[2]))}for(var u=0,d=1;d<h.length;d++)h[d][0]>h[u][0]&&(u=d);var f=new Array,g=vec2.fromValues(1,0),p=u,m=h.length+1,y=new Array;for(y.push(p);m>0;){for(;y.length>2;)y.shift();var v=n(p,g,y);if(-1==v)break;if(y.push(v),f.push(v),vec2.normalize(g,vec2.sub(g,h[p],h[v])),p=v,p==u)break;m--}if(m){var P=new Array;for(var d in f)P.push(h[f[d]]);return P}}}},calculateEdgeAngleFromAxis:function(t,e){var i=vec2.fromValues(e[0]-t[0],e[1]-t[1]),n=vec2.fromValues(1,0),o=vec2.fromValues(-1,0),a=vec2.dot(i,o),s=vec2.len(i)*vec2.len(o),r=vec2.dot(i,n),h=vec2.len(i)*vec2.len(n),l=Math.acos(r/h),d=Math.acos(a/s);return l>d?[d,-1]:[l,1]},calculateRotatedAreaBounds:function(t){for(var e,i,n,o,a=1/0,s=0,r=0,h=0,l=1,d=0,c=vec2.create(),u=vec2.create(),f=0;f<t.length-1;f++)r=this.calculateEdgeAngleFromAxis(t[f],t[f+1]),h=-1===r[1]?r[0]:Math.PI-r[0],i=this.calculateBounds(t,h),Math.abs(i[2]*i[3])<a?(a=Math.abs(i[2]*i[3]),n=t[f],o=t[f+1],e=i,l=r[1],s=l*r[0]):Math.abs(i[2]*i[3])==a&&(vec2.sub(u,n,o),vec2.sub(c,t[f],t[f+1]),d=vec2.len(u),vec2.len(c)>vec2.len(u)&&(a=Math.abs(i[2]*i[3]),n=t[f],o=t[f+1],e=i,l=r[1],s=l*r[0]));if(!e)return!1;var g=vec2.fromValues(e[0],e[1]),p=vec2.fromValues(e[2]/2,e[3]/2);return p=this.rotatePoint(p,s),-1==l?vec2.add(p,g,p):vec2.sub(p,g,p),{edge:[n,o,vec2.sub(vec2.create(),n,o),this.getOrientation(n,o,p)],angle:s,bounds:{corner:g,width:e[2],height:e[3]},center:p,direction:l}},calculateBounds:function(t,e){for(var i,n=1/0,o=1/0,a=-(1/0),s=-(1/0),r=0;r<t.length;r++)i=t[r],e&&(i=this.rotatePoint(i,e)),n=Math.min(n,i[0]),o=Math.min(o,i[1]),a=Math.max(a,i[0]),s=Math.max(s,i[1]);return i=this.rotatePoint(vec2.fromValues(n,o),-e),[i[0],i[1],a-n,s-o,a,s]},rotatePoint:function(t,e){var i=t[0]*Math.cos(e)-t[1]*Math.sin(e),n=t[1]*Math.cos(e)+t[0]*Math.sin(e);return vec2.fromValues(i,n)},getOrientation:function(t,e,i){var n=(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1]);return n>0?-1:0>n?1:0},positionToMeshCenter:function(){if(this.kioskNode){var t=this.poi.meshNode.getComponent(MeshRendererComponent),e=t.getSubmeshRenderer(this.poi.submesh),i=this.node.getComponent(MeshRendererComponent);if(!i||!i.meshRenderers)return void console.warn(this.poi.getName("en"),"no meshRenderers");var n,o=i.meshRenderers[0].globalBoundingBox,a=e.globalBoundingBox,s=e.localBoundingBox,r=new Plane,h=0,l=this.getConcaveHull(a.center,this.poi.getName("en")),d=Math.min(s.size[0],s.size[1]);r.setByNormalAndPoint([0,-1,0],a.max);var c=r.getDistanceToPoint(this.poi.node.position);0>c&&(c=0);var u=vec3.fromValues(a.center[0]-this.poi.node.position[0],this.poi.node.position[1]+c+.15,a.center[2]-this.poi.node.position[2]);l&&this.kioskNode?(n=this.calculateRotatedAreaBounds(l),n&&n.bounds?(d=n.bounds.width,h=Math.round(n.angle*(180/Math.PI)+this.kioskNode.rotation[1]),vec3.set(u,n.center[0]-this.poi.node.position[0],u[1],n.center[1]-this.poi.node.position[2])):console.warn("no area",this.poi.getName("en"),n,l)):console.warn("nohull",this.poi.getName("en"),l);var f=(Math.min(s.size[0],s.size[1]),d/o.size[0]),g=vec3.fromValues(.95*f,.95*f,1);mat4.fromRotationTranslationScale(this.node.transform.relative,quat.euler(quat.create(),-90,h,0),u,g)}}}),POIController=Controller.extend({init:function(t){this._super("POI Controller"),this.wayfinder=t,this.meshIDToPath={},this.highlights=[],this.displaying=[],this.deHighlightPOIs=this.wayfinder.settings.getBoolean("poi.dehighlight.enabled",!1)},type:function(){return"POIController"},getMeshInfo:function(t,e){if(!t||!e)return!1;var i=!1,n=[],o=t.getComponent(MeshComponent);if(o){var a=o.mesh;for(var s in a.submeshes)if(a.submeshes[s]===e){i=a.getMaterial(e.materialIndex),n.push("mesh-"+s);break}}for(var r=t,h=!1;r;){if(r.getComponent(FloorComponent)){h=r.getComponent(FloorComponent).floor;break}n.push(r.name),r=r.parent}return n.reverse(),{path:n.join("/"),floor:h,material:i}},getMeshInfoByID:function(t){return t in this.meshIDToPath?this.meshIDToPath[t]:!1},onClick:function(t,e,i,n){var o=this.node.scene.cameraComponent.screenPointToRay(t);if(o){var a=this.node.scene.dynamicSpace.rayCast(o,Layers.POI),s=a.nearest();if(s){var r=s.collider.node.getComponent(POIComponent);r&&this.onPOIClick(r.poi)}else if(a=this.node.scene.dynamicSpace.rayCast(o,Layers.Default),s=a.nearest()){var h=this.getMeshInfo(s.node,s.submesh),l=h.floor.getMeshIDByPath(h.path);if(l){for(var d in h.floor.pois)if(h.floor.pois[d].mesh_id==l)return void this.onPOIClick(h.floor.pois[d],t,n);if(this.wayfinder.settings.getBoolean("poi.3d.check-other-floors",!1))for(var d in this.wayfinder.pois)if(this.wayfinder.pois[d].mesh_id==l)return void this.onPOIClick(this.wayfinder.pois[d],t,n)}if(this.wayfinder.logic.currentFloor){var c=this.wayfinder.logic.currentFloor.pois,u=this.wayfinder.settings.getFloat("poi.activation.radius",10),f=this.wayfinder.settings.getFloat("poi.activation.duration",3);for(var d in c)if(c[d].object&&"utility"!=c[d].type&&!c[d].visible){var g=mat4.translation(vec3.create(),c[d].object.transform.absolute);vec3.distance(g,s.point)<=u&&c[d].show(f)}}}}},onPOIClick:function(t,e,i){this.clearHighlights(),this.setHighlights([t]),this.wayfinder.onPOIClick(t,e,i)},setHighlights:function(t){if(t&&"object"==typeof t){for(var e,i=0;i<t.length;i++)e=t[i],e instanceof POI3D&&(this.highlights.push(e),e.highlight());if(this.deHighlightPOIs)for(var i in this.wayfinder.pois)e=this.wayfinder.pois[i],e instanceof POI3D&&!(e in this.highlights)&&e.dehighlight()}},clearHighlights:function(){for(var t=0;t<this.highlights.length;t++)this.highlights[t].stopHighlight();this.highlights.length=0},setDisplaying:function(t){var e;if(t&&"object"==typeof t)for(var i=0;i<t.length;i++)e=t[i],e instanceof POI3D&&(e.show(),this.displaying.push(e))},clearDisplaying:function(){for(var t,e=0;e<this.displaying.length;e++)t=this.displaying[e],t.isAlwaysVisible()||t.hide();this.displaying.length=0},hidePOIs:function(t){for(var e in t)t[e]in this.displaying||t[e].hide()},showPOIs:function(t){for(var e in t)(t[e].alwaysVisible||"utility"==t[e].type||this.poiInArray(t[e],this.displaying))&&t[e].show()},stopAnimatingPOIs:function(t,e){for(var i in t)e&&t[i].node_id==e||t[i].stopAnimating()},poiInArray:function(t,e){for(var i in e)if(e[i].id==t.id)return!0;return!1}}),WayfinderOrbitController=SmoothOrbitController.extend({init:function(t){this._super(),this.wayfinder=t,this.lastPinch=0,this.lastRotation=0,this.lastDeltaX=0,this.lastDeltaY=0,this.rotatingEnabled=!0,this.rotatingTouchEnabled=!0},setZoom:function(t){this._super(t),this.wayfinder.onZoomChange(this.getZoom())},zoomIn:function(t){this._super(t),this.wayfinder.onZoomChange(this.getZoom())},zoomOut:function(t){this._super(t),this.wayfinder.onZoomChange(this.getZoom())},onMouseMove:function(t,e,i){this.rotateButton!==!1&&e==this.panButton&&this.rotatingEnabled&&this.rotate(i[1],i[0]),this.panButton!==!1&&e==this.rotateButton&&this.move(i[0],i[1])},onPan:function(t,e,i,n){var o=vec2.len(e),a=.8*o;this.rotatingTouchEnabled?("panup"===n.type&&this.rotate(-o,0),"pandown"===n.type&&this.rotate(o,0),"panleft"===n.type&&this.rotate(0,-a),"panright"===n.type&&this.rotate(0,a)):this.move(e[0],e[1])},onMultiDrag:function(t){var e=t.gesture;Math.abs(e.angle)>100&&("down"==e.direction?this.rotate(0,1):"up"==e.direction&&this.rotate(0,1))},onRotate:function(t,e){this.rotatingEnabled&&this.rotateY(e)},rotateX:function(t){var e=t*(Math.PI/180);this.rotation[0]=this.rotation[0]+e},rotateY:function(t){var e=t*(Math.PI/180);this.rotation[1]=this.rotation[1]+e},rotateZ:function(t){var e=t*(Math.PI/180);this.rotation[2]=this.rotation[2]+e},onDrag:function(t){t.gesture.preventDefault(),t.gesture&&(this.move(-(t.gesture.deltaX-this.lastDeltaX),-(t.gesture.deltaY-this.lastDeltaY)),this.lastDeltaX=t.gesture.deltaX,this.lastDeltaY=t.gesture.deltaY)},onTouchRelease:function(){this.lastPinch=0,this.lastRotation=0,this.lastDeltaY=0,this.lastDeltaX=0},move:function(t,e){var i=vec3.create();vec3.scale(i,this.panXAxis,-t),vec3.add(i,i,vec3.scale(vec3.create(),this.panYAxis,-e)),i=vec3.scale(i,i,this.distance/900);var n=quat.fromMat4(quat.create(),this.node.transform.absolute),o=vec3.fromValues(0,0,1);vec3.transformQuat(o,o,n);var a=Math.atan2(o[2],o[0]);a-=Math.PI/2,quat.identity(n),quat.rotateY(n,n,a),quat.conjugate(n,n),quat.normalize(n,n),vec3.transformQuat(i,i,n),vec3.add(this.pan,this.pan,i),this.pan[0]=Math.max(this.pan[0],this.minimumPan[0]),this.pan[1]=Math.max(this.pan[1],this.minimumPan[1]),this.pan[2]=Math.max(this.pan[2],this.minimumPan[2]),this.pan[0]=Math.min(this.pan[0],this.maximumPan[0]),this.pan[1]=Math.min(this.pan[1],this.maximumPan[1]),this.pan[2]=Math.min(this.pan[2],this.maximumPan[2]),this.onChange("move",t,e)},enableRotation:function(t){this.rotatingEnabled=t},enableTouchRotation:function(t){this.rotatingTouchEnabled=t}}),YAHComponent=Component.extend({init:function(t){this._super("YAH Component"),this.kioskNode=t,this.offsetY=0},type:function(){return"YAHComponent"},onStart:function(){if(this.kioskNode){var t=this.kioskNode.floor.node3D.getBoundingBox(),e=new Plane;e.setByNormalAndPoint([0,-1,0],t.max);var i=e.getDistanceToPoint(this.kioskNode.position);0>i&&(i=0),mat4.fromRotationTranslation(this.node.transform.relative,quat.create(),[0,i+this.offsetY,0])}}});